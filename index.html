<DOCUMENT filename="daily.html">
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Spend Tracker</title>
<!-- ‚ïê‚ïê‚ïê PWA / STANDALONE META ‚ïê‚ïê‚ïê -->
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<!-- Android / Chrome PWA -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#4f6ef7">
<meta name="application-name" content="SpendTrack">
<meta name="description" content="Track your daily spending. Personal finance app with real-time sync.">

<!-- Apple / iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SpendTrack">

<!-- MS Tiles (optional, for Edge) -->
<meta name="msapplication-TileColor" content="#4f6ef7">
<meta name="msapplication-tap-highlight" content="no">
<meta name="display-mode" content="standalone">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js" onerror="window._emailJsLoadFailed=true"></script>

<style>
:root{
  --bg:#f0f4ff;--surface:#fff;--s2:#f7f9ff;--border:#e2e8f8;
  --primary:#4f6ef7;--pl:#eef1ff;--pd:#3451d1;
  --green:#10b981;--red:#ef4444;--yellow:#f59e0b;
  --text:#1e2a4a;--t2:#64748b;--t3:#a0aec0;
  --sh:0 2px 16px rgba(79,110,247,.07);--sh2:0 4px 24px rgba(79,110,247,.12);
  --r:16px;--rs:10px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
button,a,[onclick]{touch-action:manipulation;user-select:none;-webkit-user-select:none}
button:active{opacity:.82}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);margin:0}
body{font-family:'Plus Jakarta Sans',sans-serif;color:var(--text)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ */
#splash{position:fixed;top:0;left:0;width:100%;height:100dvh;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9000}
.splash-logo{font-size:52px;margin-bottom:12px;animation:pop .5s ease}
.splash-title{font-size:24px;font-weight:800;background:linear-gradient(135deg,var(--primary),#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.splash-sub{font-size:13px;color:var(--t3);margin-top:6px}
@keyframes pop{0%{transform:scale(.6);opacity:0}100%{transform:scale(1);opacity:1}}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#auth-screen{width:100%;max-width:520px;height:100dvh;overflow-y:auto;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;margin:0 auto}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:30px 24px;width:100%;box-shadow:var(--sh2)}
.auth-logo{font-size:40px;text-align:center;margin-bottom:8px}
.auth-title{font-size:22px;font-weight:800;text-align:center;background:linear-gradient(135deg,var(--primary),#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:4px}
.auth-sub{font-size:13px;color:var(--t3);text-align:center;margin-bottom:24px}
.auth-tabs{display:grid;grid-template-columns:1fr 1fr;background:var(--s2);border-radius:12px;padding:4px;margin-bottom:22px;gap:4px}
.auth-tab{padding:9px;border:none;border-radius:9px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;background:none;color:var(--t3);transition:all .2s}
.auth-tab.active{background:var(--surface);color:var(--primary);box-shadow:var(--sh)}
.fg{margin-bottom:14px}
.flbl{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:7px;display:block}
.fi{background:var(--s2);border:1.5px solid var(--border);border-radius:var(--rs);color:var(--text);padding:12px 14px;width:100%;font-family:inherit;font-size:16px;outline:none;transition:border-color .2s,background .2s}
.fi:focus{border-color:var(--primary);background:#fff}
.auth-err{font-size:12px;color:var(--red);margin-bottom:10px;min-height:16px;font-weight:600}
.btn-primary{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),#a855f7);border:none;border-radius:12px;color:#fff;font-family:inherit;font-weight:800;font-size:15px;cursor:pointer;box-shadow:0 4px 14px rgba(79,110,247,.3);transition:transform .15s,opacity .2s}
.btn-primary:active{transform:scale(.97)}
.btn-primary:disabled{opacity:.6;cursor:not-allowed}
.auth-footer{font-size:11px;color:var(--t3);text-align:center;margin-top:16px;line-height:1.6}
/* ‚îÄ‚îÄ OTP VERIFICATION PANEL ‚îÄ‚îÄ */
.verify-panel{display:none;text-align:center;padding:4px 0}
.verify-panel.show{display:block}
.verify-icon{font-size:44px;margin-bottom:10px}
.verify-title{font-size:17px;font-weight:800;color:var(--text);margin-bottom:6px}
.verify-msg{font-size:13px;color:var(--t2);line-height:1.6;margin-bottom:6px}
.verify-email-pill{display:inline-block;background:var(--pl);border:1px solid #c7d2fe;border-radius:20px;padding:5px 14px;font-size:13px;font-weight:700;color:var(--pd);margin-bottom:18px;word-break:break-all}
/* OTP 6-box row */
.otp-row{display:flex;gap:8px;justify-content:center;margin-bottom:18px}
.otp-box{width:44px;height:54px;border:2px solid var(--border);border-radius:12px;background:var(--s2);font-family:'DM Mono',monospace;font-size:22px;font-weight:700;color:var(--primary);text-align:center;outline:none;caret-color:transparent;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none}
.otp-box:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,110,247,.15);background:#fff}
.otp-box.filled{border-color:var(--primary);background:#fff}
.otp-box.error{border-color:var(--red);background:#fff5f5;animation:shake .3s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.otp-err{font-size:12px;color:var(--red);font-weight:600;min-height:18px;margin-bottom:10px}
.otp-timer{font-size:12px;color:var(--t3);margin-bottom:14px;font-weight:600}
.otp-timer span{color:var(--primary);font-family:'DM Mono',monospace}
.btn-verify-otp{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),#a855f7);border:none;border-radius:12px;color:#fff;font-family:inherit;font-weight:800;font-size:15px;cursor:pointer;box-shadow:0 4px 14px rgba(79,110,247,.3);transition:transform .15s,opacity .2s;margin-bottom:10px}
.btn-verify-otp:active{transform:scale(.97)}
.btn-verify-otp:disabled{opacity:.5;cursor:not-allowed}
.btn-resend{background:none;border:1.5px solid var(--border);border-radius:10px;color:var(--t2);font-family:inherit;font-size:13px;font-weight:700;padding:10px 18px;cursor:pointer;width:100%;transition:background .2s,border-color .2s,color .2s;margin-bottom:10px}
.btn-resend:hover:not(:disabled){background:var(--pl);border-color:var(--primary);color:var(--primary)}
.btn-resend:disabled{opacity:.45;cursor:not-allowed}
.resend-ok{font-size:12px;color:var(--green);font-weight:600;min-height:16px;margin-bottom:6px}
.back-to-login{font-size:12px;color:var(--t3);text-decoration:underline;cursor:pointer;background:none;border:none;font-family:inherit;margin-top:2px}
.back-to-login:hover{color:var(--primary)}
.auth-link{font-size:12px;color:var(--primary);font-weight:700;cursor:pointer;text-decoration:underline;background:none;border:none;font-family:inherit;padding:0}
.auth-link:hover{color:var(--pd)}
/* EmailJS not configured warning */
.emailjs-warn{background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:10px 12px;font-size:11px;color:#92400e;line-height:1.5;margin-bottom:14px;text-align:left}
/* Forgot password panel */
.forgot-panel{display:none;padding:4px 0}
.forgot-panel.show{display:block}
.forgot-title{font-size:16px;font-weight:800;color:var(--text);margin-bottom:6px;text-align:center}
.forgot-sub{font-size:13px;color:var(--t2);text-align:center;margin-bottom:18px;line-height:1.5}
.forgot-success{display:none;text-align:center;padding:10px 0}
.forgot-success.show{display:block}
.forgot-success-icon{font-size:40px;margin-bottom:10px}
.forgot-success-msg{font-size:14px;color:var(--t2);line-height:1.6}
.forgot-link{font-size:12px;color:var(--primary);font-weight:700;cursor:pointer;background:none;border:none;font-family:inherit;text-decoration:underline;display:block;text-align:right;margin-bottom:14px;padding:0}
.forgot-link:hover{color:var(--pd)}
.divider{display:flex;align-items:center;gap:10px;margin:16px 0;color:var(--t3);font-size:12px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
#app{width:100%;max-width:820px;height:100dvh;position:relative;display:none;flex-direction:column;margin:0 auto;overflow:hidden}

/* HEADER */
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px 12px;position:sticky;top:0;z-index:100;flex-shrink:0}
.hdr-inner{display:flex;justify-content:space-between;align-items:center}
.brand-sub{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--t3)}
.brand-name{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--primary),#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hdr-r{display:flex;gap:6px;align-items:center}
.btn-add{background:linear-gradient(135deg,var(--primary),#a855f7);color:#fff;border:none;border-radius:11px;padding:9px 16px;font-family:inherit;font-weight:700;font-size:14px;cursor:pointer;box-shadow:0 4px 14px rgba(79,110,247,.3);transition:transform .15s}
.btn-add:active{transform:scale(.96)}
.bico{background:var(--s2);border:1.5px solid var(--border);border-radius:10px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;font-size:17px;cursor:pointer;transition:background .2s;flex-shrink:0}
.bico:hover{background:var(--pl);border-color:var(--primary)}

/* SYNC BAR */
.scroll-wrap{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain}
.scroll-wrap::-webkit-scrollbar{width:4px}.scroll-wrap::-webkit-scrollbar-track{background:transparent}.scroll-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.sync-bar{display:flex;align-items:center;gap:7px;padding:5px 16px;font-size:11px;font-weight:600;border-bottom:1px solid var(--border);transition:background .3s;flex-shrink:0}
.sync-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.sync-bar.ok{background:#f0fdf4;color:#065f46}.sync-bar.ok .sync-dot{background:var(--green)}
.sync-bar.busy{background:#fffbeb;color:#92400e}.sync-bar.busy .sync-dot{background:var(--yellow);animation:blink 1s infinite}
.sync-bar.err{background:#fef2f2;color:#991b1b}.sync-bar.err .sync-dot{background:var(--red)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

/* PAGES */
.page{display:none;padding:16px 16px calc(16px) 16px;animation:fadeUp .25s ease}
.page.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--sh)}

/* STATS TOOLBAR */
.stats-toolbar{display:flex;gap:8px;overflow-x:auto;padding:0 0 4px;margin-bottom:12px;-webkit-overflow-scrolling:touch}
.stats-toolbar::-webkit-scrollbar{display:none}
.sc{flex:0 0 auto;border-radius:12px;padding:10px 14px;display:flex;flex-direction:column;min-width:110px}
.sc.trend{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border:1px solid #bae6fd;min-width:160px;cursor:default}
.sc.trend .sc-lbl{color:#0369a1}
.sc.trend .sc-amt{color:#0c4a6e;font-size:11px;font-family:inherit;font-weight:600}
.sc.trend .sc-sub{color:#38bdf8}
.trend-sparkline{display:flex;align-items:flex-end;gap:2px;height:28px;margin-top:6px}
.tsbar{flex:1;border-radius:2px 2px 0 0;background:linear-gradient(180deg,#0ea5e9,#6366f1);min-height:3px;transition:height .5s ease}

/* CURRENCY SELECT */
.curr-sel{background:var(--s2);border:1.5px solid var(--border);border-radius:var(--rs);color:var(--text);padding:9px 12px;font-family:inherit;font-size:14px;font-weight:700;outline:none;cursor:pointer;width:auto;transition:border-color .2s}
.curr-sel:focus{border-color:var(--primary)}

/* AMOUNT INPUT WRAPPER */
.amt-wrap{position:relative;display:flex;align-items:center}
.amt-wrap .amt-prefix{position:absolute;left:14px;font-size:13px;font-weight:700;color:var(--t3);pointer-events:none;font-family:'DM Mono',monospace}
.amt-wrap .fi{padding-left:44px !important;font-family:'DM Mono',monospace;letter-spacing:.3px}
.sc.today{background:linear-gradient(135deg,#eef1ff,#e8edff);border:1px solid #c7d2fe}
.sc.month{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #bbf7d0}
.sc-lbl{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px}
.sc.today .sc-lbl{color:var(--primary)}.sc.month .sc-lbl{color:var(--green)}
.sc-amt{font-family:'DM Mono',monospace;font-size:14px;font-weight:500}
.sc.today .sc-amt{color:var(--pd)}.sc.month .sc-amt{color:#065f46}
.sc-sub{font-size:10px;margin-top:2px}
.sc.today .sc-sub{color:#818cf8}.sc.month .sc-sub{color:#34d399}
.sec-lbl{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:10px}

/* BUDGET */
.bgt-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.bgt-title{font-size:12px;font-weight:700}
.bgt-pct{font-family:'DM Mono',monospace;font-size:12px;font-weight:500}
.bgt-track{height:7px;background:var(--pl);border-radius:10px;overflow:hidden}
.bgt-fill{height:100%;border-radius:10px;transition:width 1s cubic-bezier(.23,1,.32,1)}
.bgt-footer{display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--t3)}
.bgt-iw{display:flex;align-items:center;gap:5px}
.bgt-inp{background:var(--pl);border:1px solid #c7d2fe;border-radius:7px;color:var(--text);padding:3px 7px;font-size:11px;font-family:'DM Mono',monospace;width:88px;text-align:right;outline:none}
.bgt-inp:focus{border-color:var(--primary)}
.bgt-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;box-shadow:var(--sh);margin-bottom:10px}

/* CHART (kept for cat breakdown) */
.chart-bars{display:flex;align-items:flex-end;gap:4px;height:90px}
.cat-row{margin-bottom:10px}
.cat-row-top{display:flex;justify-content:space-between;margin-bottom:4px}
.cat-row-name{font-size:13px;color:var(--t2)}
.cat-row-amt{font-family:'DM Mono',monospace;font-size:13px;font-weight:500}
.cat-track{height:5px;background:var(--s2);border-radius:5px;overflow:hidden}
.cat-fill{height:100%;border-radius:5px;transition:width .8s ease}

/* ENTRIES */
.elist{display:flex;flex-direction:column;gap:8px}
.eitem{display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:var(--sh);transition:border-color .2s,box-shadow .2s}
.eitem:hover{border-color:#c7d2fe;box-shadow:var(--sh2)}
.e-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.e-info{flex:1;min-width:0}
.e-name{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.e-meta{font-size:11px;color:var(--t3);margin-top:2px}
.e-note{font-size:11px;color:var(--t3);font-style:italic;margin-top:2px}
.e-amt{font-family:'DM Mono',monospace;font-size:15px;font-weight:500;flex-shrink:0}
.e-acts{display:none;gap:2px}
.e-acts.visible{display:flex}
.ibtn{background:none;border:none;cursor:pointer;padding:6px;border-radius:8px;font-size:15px;transition:background .2s}
.ibtn.ed:hover{background:#eef1ff}.ibtn.dl:hover{background:#fee2e2}

/* EDIT MODE TOGGLE */
.edit-mode-btn{background:var(--s2);border:1.5px solid var(--border);border-radius:10px;padding:6px 12px;font-family:inherit;font-size:12px;font-weight:700;color:var(--t2);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
.edit-mode-btn.active{background:var(--pl);border-color:var(--primary);color:var(--primary)}
.section-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.view-all-btn{width:100%;padding:11px;background:none;border:1px dashed var(--border);border-radius:12px;color:var(--primary);font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;transition:background .2s;margin-top:4px}
.view-all-btn:hover{background:var(--pl)}
.empty{text-align:center;padding:40px 20px;color:var(--t3)}
.empty-icon{font-size:40px;margin-bottom:10px}
.empty-text{font-size:14px}

/* FORM */
.frow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.ftitle{font-size:20px;font-weight:800;margin-bottom:18px}

/* CAT PICKER */
.cat-grid-wrap{max-height:210px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-right:2px;border-radius:12px}
.cat-grid-wrap::-webkit-scrollbar{width:4px}.cat-grid-wrap::-webkit-scrollbar-track{background:var(--s2);border-radius:4px}.cat-grid-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.cat-search{width:100%;background:var(--s2);border:1.5px solid var(--border);border-radius:var(--rs);color:var(--text);padding:9px 12px;font-family:inherit;font-size:14px;outline:none;margin-bottom:8px;transition:border-color .2s}
.cat-search:focus{border-color:var(--primary)}
.cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.cpill{border-radius:12px;padding:10px 6px;text-align:center;cursor:pointer;border:2px solid transparent;transition:all .2s;background:var(--s2)}

/* INSIGHTS */
.insights-row{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px}
.insights-row::-webkit-scrollbar{display:none}
.insight-chip{display:flex;align-items:center;gap:7px;background:var(--surface);border:1px solid var(--border);border-radius:30px;padding:8px 14px;white-space:nowrap;box-shadow:var(--sh);flex-shrink:0}
.insight-chip .i-ico{font-size:15px}
.insight-chip .i-txt{font-size:12px;font-weight:700;color:var(--t2)}
.insight-chip .i-val{font-size:12px;font-weight:800;color:var(--primary)}

/* DAILY AVG */
.sc.avg{background:linear-gradient(135deg,#fff7ed,#fef3c7);border:1px solid #fde68a}
.sc.avg .sc-lbl{color:#d97706}.sc.avg .sc-amt{color:#92400e}.sc.avg .sc-sub{color:#f59e0b}
.cpill-icon{font-size:22px;margin-bottom:3px}
.cpill-name{font-size:10px;font-weight:700;color:var(--t2)}
.cpill.sel .cpill-name{font-weight:800}

/* FORM BTNS */
.fbtns{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px}
.btn-cancel{padding:13px;background:var(--s2);border:1.5px solid var(--border);border-radius:12px;color:var(--t2);font-family:inherit;font-weight:700;font-size:14px;cursor:pointer}
.btn-cancel:hover{background:var(--border)}
.btn-save{padding:13px;background:linear-gradient(135deg,var(--primary),#a855f7);border:none;border-radius:12px;color:#fff;font-family:inherit;font-weight:700;font-size:14px;cursor:pointer;box-shadow:0 4px 14px rgba(79,110,247,.3);transition:transform .15s}
.btn-save:active{transform:scale(.97)}

/* SEARCH */
.srch-count{font-size:12px;color:var(--t3);margin:6px 0 12px}
.clear-btn{display:block;width:100%;padding:9px;background:none;border:1px solid var(--border);border-radius:10px;color:var(--t3);font-family:inherit;font-size:13px;cursor:pointer;margin-bottom:12px}
.clear-btn:hover{background:var(--s2)}
.srch-total-card{text-align:center;padding:16px}
.srch-total-lbl{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:4px}
.srch-total-amt{font-family:'DM Mono',monospace;font-size:26px;font-weight:500;color:var(--primary)}

/* SEARCH DATE MODE TABS */
.date-mode-tabs{display:grid;grid-template-columns:repeat(3,1fr);background:var(--s2);border:1.5px solid var(--border);border-radius:12px;padding:3px;gap:3px;margin-bottom:12px}
.dmt{padding:7px;border:none;border-radius:9px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;background:none;color:var(--t3);transition:all .2s}
.dmt.active{background:var(--surface);color:var(--primary);box-shadow:var(--sh)}

/* SORT BAR */
.sort-bar{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.sort-lbl{font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:1px;white-space:nowrap}
.sort-btn{padding:5px 12px;border-radius:20px;border:1.5px solid var(--border);background:var(--s2);font-family:inherit;font-size:11px;font-weight:700;color:var(--t3);cursor:pointer;transition:all .2s;white-space:nowrap}
.sort-btn.active{background:var(--pl);border-color:var(--primary);color:var(--primary)}

/* DANGER CONFIRM MODAL */
.danger-overlay{display:none;position:fixed;inset:0;background:rgba(30,42,74,.4);backdrop-filter:blur(4px);z-index:600;justify-content:center;align-items:center;padding:20px}
.danger-overlay.open{display:flex}
.danger-box{background:var(--surface);border-radius:20px;padding:28px 24px;width:100%;max-width:400px;box-shadow:0 8px 40px rgba(239,68,68,.2);border:1.5px solid #fecaca;animation:slideUp .25s ease}
.danger-icon{font-size:40px;text-align:center;margin-bottom:12px}
.danger-title{font-size:18px;font-weight:800;color:#991b1b;text-align:center;margin-bottom:6px}
.danger-sub{font-size:13px;color:var(--t2);text-align:center;margin-bottom:20px;line-height:1.6}
.danger-confirm-row{margin-bottom:18px}
.danger-confirm-lbl{font-size:11px;font-weight:700;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:7px;display:block}
.danger-inp{width:100%;background:#fff5f5;border:2px solid #fecaca;border-radius:10px;padding:11px 14px;font-family:'DM Mono',monospace;font-size:15px;font-weight:700;color:#991b1b;text-align:center;outline:none;transition:border-color .2s;letter-spacing:2px}
.danger-inp:focus{border-color:var(--red)}
.danger-inp.valid{border-color:var(--red);background:#fee2e2}
.danger-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.danger-cancel{padding:12px;background:var(--s2);border:1.5px solid var(--border);border-radius:12px;color:var(--t2);font-family:inherit;font-weight:700;font-size:14px;cursor:pointer}
.danger-confirm{padding:12px;background:#ef4444;border:none;border-radius:12px;color:#fff;font-family:inherit;font-weight:800;font-size:14px;cursor:pointer;opacity:.4;transition:opacity .2s}
.danger-confirm.ready{opacity:1}

/* HISTORY */
.hist-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.hist-total{font-family:'DM Mono',monospace;font-size:13px;color:var(--t3)}

/* CATEGORIES PAGE */
.cats-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.btn-new-cat{background:linear-gradient(135deg,var(--primary),#a855f7);color:#fff;border:none;border-radius:10px;padding:9px 14px;font-family:inherit;font-weight:700;font-size:13px;cursor:pointer;box-shadow:0 3px 10px rgba(79,110,247,.25)}
.cm-list{display:flex;flex-direction:column;gap:10px}
.cm-item{display:flex;align-items:center;gap:12px;padding:13px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:14px;box-shadow:var(--sh);transition:border-color .2s}
.cm-item:hover{border-color:#c7d2fe}
.cm-ico{width:44px;height:44px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.cm-info{flex:1;min-width:0}
.cm-name{font-weight:700;font-size:15px}
.cm-sub{font-size:11px;color:var(--t3);margin-top:2px}
.cm-acts{display:flex;gap:6px;align-items:center;flex-shrink:0}
.cm-edit-btn{background:var(--pl);border:none;border-radius:8px;color:var(--primary);padding:7px 10px;font-size:13px;cursor:pointer;font-family:inherit;font-weight:700}
.cm-edit-btn:hover{background:#c7d2fe}
.cm-del-btn{background:#fee2e2;border:none;border-radius:8px;color:var(--red);padding:7px 10px;font-size:13px;cursor:pointer;font-family:inherit;font-weight:700}
.cm-del-btn:hover{background:#fecaca}
.cm-badge{font-size:10px;font-weight:700;color:var(--t3);background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:4px 9px;white-space:nowrap}
.info-box{background:var(--pl);border:1px solid #c7d2fe;border-radius:10px;padding:10px 14px;font-size:12px;color:var(--pd);margin-bottom:14px;line-height:1.5}

/* CAT MODAL */
.cat-form-row{display:grid;grid-template-columns:78px 1fr;gap:12px;margin-bottom:14px;align-items:start}
.emoji-inp{font-size:26px;text-align:center;cursor:pointer;padding:8px;border-radius:12px;width:100%;background:var(--s2);border:1.5px solid var(--border);outline:none;font-family:inherit}
.emoji-inp:focus{border-color:var(--primary)}
.emoji-hint{font-size:10px;color:var(--t3);text-align:center;margin-top:4px}
.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:7px;margin-top:6px}
.cswatch{width:100%;aspect-ratio:1;border-radius:8px;cursor:pointer;border:3px solid transparent;transition:transform .15s,border-color .15s}
.cswatch:hover{transform:scale(1.15)}
.cswatch.sel{border-color:var(--text);transform:scale(1.1)}
.custom-color-row{display:flex;gap:10px;align-items:center;margin-top:10px}
.custom-color-lbl{font-size:12px;color:var(--t3);font-weight:600;white-space:nowrap}
input[type=color]{width:40px;height:36px;border:1.5px solid var(--border);border-radius:8px;padding:2px;cursor:pointer;background:var(--s2);outline:none}
input[type=color]:focus{border-color:var(--primary)}
.color-preview{display:flex;align-items:center;gap:8px;margin-top:10px;padding:10px 14px;background:var(--s2);border-radius:10px;border:1px solid var(--border)}
.preview-dot{width:18px;height:18px;border-radius:50%;flex-shrink:0}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE ‚Äî max-width: 480px
   Inspired by index.html responsive patterns
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media (max-width: 480px) {

  /* ‚îÄ‚îÄ Header: compact on small screens ‚îÄ‚îÄ */
  .hdr { padding: 10px 12px 8px; }
  .brand-sub { font-size: 8px; }
  .brand-name { font-size: 17px; }
  .btn-add { 
    position: fixed;
    bottom: calc(max(14px, env(safe-area-inset-bottom)) + 68px);
    right: 16px;
    padding: 14px 20px;
    border-radius: 50px;
    font-size: 15px;
    z-index: 150;
    width: auto;
    box-shadow: 0 6px 24px rgba(79,110,247,.4);
    margin: 0 !important;
    letter-spacing: .3px;
  }
  .bico { width: 34px; height: 34px; font-size: 15px; border-radius: 9px; }
  .hdr-r { gap: 4px; }
  
  /* ‚îÄ‚îÄ Stats toolbar: adjust cards for mobile comfort ‚îÄ‚îÄ */
  .stats-toolbar { gap: 6px; }
  .sc { min-width: 80px; padding: 9px 10px; border-radius: 10px; }
  .sc.trend { min-width: 118px; }
  .sc-lbl { font-size: 9px; letter-spacing: 0.6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
  .sc-amt { font-size: 12px; line-height: 1.3; }
  .sc-sub { font-size: 9px; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* ‚îÄ‚îÄ Specific label text replacement for mobile ‚îÄ‚îÄ */
  .sc.today .sc-lbl::before { content: 'TODAY'; }
  .sc.today .sc-lbl { font-size: 0; }
  .sc.today .sc-lbl::before { font-size: 9px; }
  .sc.month .sc-lbl::before { content: 'THIS MTH'; }
  .sc.month .sc-lbl { font-size: 0; }
  .sc.month .sc-lbl::before { font-size: 9px; }
  .sc.avg .sc-lbl::before { content: 'DAILY AVG'; }
  .sc.avg .sc-lbl { font-size: 0; }
  .sc.avg .sc-lbl::before { font-size: 9px; }
  .sc.biggest-stat .sc-lbl::before { content: 'BIGGEST'; }
  .sc.biggest-stat .sc-lbl { font-size: 0; }
  .sc.biggest-stat .sc-lbl::before { font-size: 9px; color: #7c3aed; }
  .sc.trend .sc-lbl::before { content: 'TREND'; }
  .sc.trend .sc-lbl { font-size: 0; }
  .sc.trend .sc-lbl::before { font-size: 9px; }

  /* ‚îÄ‚îÄ Pages: tighter side padding with bottom padding for floating button ‚îÄ‚îÄ */
  .page { padding: 12px 12px 110px 12px; }

  /* ‚îÄ‚îÄ Page titles ‚îÄ‚îÄ */
  .ftitle { font-size: 18px; margin-bottom: 14px; }

  /* ‚îÄ‚îÄ Budget card ‚îÄ‚îÄ */
  .bgt-card { padding: 10px 12px; }

  /* ‚îÄ‚îÄ Form: stack amount + date on one column ‚îÄ‚îÄ */
  .frow { grid-template-columns: 1fr; gap: 0; }

  /* ‚îÄ‚îÄ Form buttons: keep 2-col but slightly smaller ‚îÄ‚îÄ */
  .btn-cancel, .btn-save { padding: 12px; font-size: 13px; }

  /* ‚îÄ‚îÄ Category grid: 3 cols instead of 4 ‚îÄ‚îÄ */
  .cat-grid { grid-template-columns: repeat(3, 1fr); }

  /* ‚îÄ‚îÄ Category manager: wrap actions below on tiny screens ‚îÄ‚îÄ */
  .cm-item { flex-wrap: wrap; gap: 8px; }
  .cm-info { flex: 1 1 calc(100% - 60px); }
  .cm-acts { flex-wrap: wrap; }
  .cm-edit-btn, .cm-del-btn { padding: 6px 10px; font-size: 12px; }

  /* ‚îÄ‚îÄ Colour swatch grid: 6 cols instead of 8 ‚îÄ‚îÄ */
  .color-grid { grid-template-columns: repeat(6, 1fr); gap: 6px; }

  /* ‚îÄ‚îÄ Settings rows: wrap button below label on tight rows ‚îÄ‚îÄ */
  .st-row { flex-wrap: wrap; gap: 10px; }
  .st-info { flex: 1 1 100%; }
  .sbtn { width: 100%; text-align: center; }
  .curr-sel { width: 100%; }

  /* ‚îÄ‚îÄ History header: allow wrapping ‚îÄ‚îÄ */
  .hist-hdr { flex-wrap: wrap; gap: 8px; }
  .hist-total { font-size: 11px; }

  /* ‚îÄ‚îÄ Sort bar: wrap if needed ‚îÄ‚îÄ */
  .sort-bar { flex-wrap: wrap; }

  /* ‚îÄ‚îÄ Search: full-width date pickers ‚îÄ‚îÄ */
  .fi[type="date"], .fi[type="month"] { font-size: 14px; }

  /* ‚îÄ‚îÄ Danger modal: full-width on mobile ‚îÄ‚îÄ */
  .danger-overlay { padding: 0; align-items: flex-end; }
  .danger-box { border-radius: 20px 20px 0 0; max-width: 100%; padding: 22px 16px max(24px, env(safe-area-inset-bottom)); }

  /* ‚îÄ‚îÄ Entry items: reduce gap slightly ‚îÄ‚îÄ */
  .eitem { padding: 10px; gap: 10px; }
  .e-icon { width: 38px; height: 38px; font-size: 18px; }
  .e-name { font-size: 13px; }
  .e-amt { font-size: 14px; }

  /* ‚îÄ‚îÄ Insights chips: slightly smaller ‚îÄ‚îÄ */
  .insight-chip { padding: 6px 11px; }
  .insight-chip .i-txt, .insight-chip .i-val { font-size: 11px; }

  /* ‚îÄ‚îÄ Auth card: reduce padding ‚îÄ‚îÄ */
  .auth-card { padding: 24px 16px; border-radius: 18px; }
  #auth-screen { padding: 14px; }

  /* ‚îÄ‚îÄ Sync bar: smaller text ‚îÄ‚îÄ */
  .sync-bar { font-size: 10px; padding: 4px 12px; }

  /* ‚îÄ‚îÄ Min touch targets for all interactive controls ‚îÄ‚îÄ */
  .ibtn { padding: 8px; min-width: 36px; min-height: 36px; }
  .edit-mode-btn { padding: 6px 10px; font-size: 11px; }
  .dmt { padding: 6px; font-size: 11px; }
  .sort-btn { padding: 5px 10px; font-size: 11px; }
  .view-all-btn { padding: 10px; font-size: 12px; }

  /* ‚îÄ‚îÄ Empty states ‚îÄ‚îÄ */
  .empty { padding: 28px 16px; }
  .empty-icon { font-size: 32px; }
}

/* ‚îÄ‚îÄ Tablet / wider phone landscape ‚îÄ‚îÄ */
@media (min-width: 481px) and (max-width: 720px) {
  .frow { grid-template-columns: 1fr 1fr; }
  .cat-grid { grid-template-columns: repeat(4, 1fr); }
  .color-grid { grid-template-columns: repeat(8, 1fr); }
}

/* ‚îÄ‚îÄ DESKTOP: hide btn-add from header, show section button ‚îÄ‚îÄ */
@media (min-width: 481px) {
  .hdr .btn-add { display: none; }
  .sec-add-btn-wrap { display: flex; justify-content: flex-end; margin-bottom: 10px; }
}

/* ‚îÄ‚îÄ MOBILE: hide section add button wrapper ‚îÄ‚îÄ */
@media (max-width: 480px) {
  .sec-add-btn-wrap { display: none; }
  /* scroll-to-top button */
  #scroll-top-btn {
    position: fixed;
    right: 16px;
    bottom: calc(max(14px, env(safe-area-inset-bottom)) + 128px);
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: var(--surface);
    border: 1.5px solid var(--border);
    box-shadow: var(--sh2);
    font-size: 16px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 148;
    transition: opacity .25s;
    color: var(--t2);
  }
  #scroll-top-btn.visible { display: flex; }
}


.st-section-title{font-size:11px;font-weight:800;color:var(--t2);margin-bottom:10px;text-transform:uppercase;letter-spacing:1.2px}
.st-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;box-shadow:var(--sh)}
.st-info .st-label{font-weight:700;font-size:14px}
.st-info .st-sub{font-size:11px;color:var(--t3);margin-top:2px}
.sbtn{border:none;border-radius:10px;padding:9px 14px;font-family:inherit;font-weight:700;font-size:13px;cursor:pointer;white-space:nowrap;transition:opacity .2s}
.sbtn:active{opacity:.8}
.sbtn.green{background:#dcfce7;color:#065f46}.sbtn.green:hover{background:#bbf7d0}
.sbtn.blue{background:var(--pl);color:var(--pd)}.sbtn.blue:hover{background:#c7d2fe}
.sbtn.red{background:#fee2e2;color:#991b1b}.sbtn.red:hover{background:#fecaca}
.sbtn.orange{background:#fff7ed;color:#9a3412}.sbtn.orange:hover{background:#fed7aa}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(30,42,74,.28);backdrop-filter:blur(3px);z-index:500;justify-content:flex-end;align-items:flex-end}
.overlay.open{display:flex}
.mbox{background:var(--surface);width:100%;max-width:720px;border-radius:24px 24px 0 0;padding:12px 20px max(28px,env(safe-area-inset-bottom)) 20px;max-height:95dvh;overflow-y:auto;animation:slideUp .3s cubic-bezier(.23,1,.32,1);margin:0 auto}
.mhandle{width:40px;height:4px;background:var(--border);border-radius:4px;margin:0 auto 18px;flex-shrink:0}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

/* On wider screens: center the modal as a floating card */
@media (min-width: 600px) {
  .overlay{align-items:center;justify-content:center}
  .mbox{border-radius:24px;padding:24px 20px 32px;max-height:92dvh;max-width:540px}
  .mhandle{display:none}
}

/* NAV */
.bnav{width:100%;background:var(--surface);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 0 max(14px,env(safe-area-inset-bottom));z-index:200;box-shadow:0 -4px 20px rgba(79,110,247,.06);flex-shrink:0}
.nbtn{background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 10px;border-radius:12px;transition:background .2s;min-width:52px;min-height:44px;justify-content:center}
.nbtn:hover{background:var(--pl)}
.n-icon{font-size:18px;line-height:1}
.n-lbl{font-size:10px;font-weight:700;color:var(--t3);font-family:inherit}
.nbtn.active .n-lbl{color:var(--primary)}

/* ‚îÄ‚îÄ UPDATE BANNER ‚îÄ‚îÄ */
#update-banner {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 9px 14px;
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border-bottom: 1px solid #bbf7d0;
  flex-shrink: 0;
  animation: fadeUp .3s ease;
  z-index: 210;
}
#update-banner.show { display: flex; }
.update-txt { flex: 1; font-size: 12px; font-weight: 700; color: #065f46; }
.update-btn { background: var(--green); color: #fff; border: none; border-radius: 9px; padding: 7px 14px; font-family: inherit; font-size: 12px; font-weight: 700; cursor: pointer; flex-shrink: 0; }

/* ‚îÄ‚îÄ STANDALONE MODE INDICATOR ‚îÄ‚îÄ */
@media (display-mode: standalone) {
  /* Extra top padding to account for the notch / status bar */
  .hdr { padding-top: max(14px, env(safe-area-inset-top)); }
  /* Remove the "splash" feel ‚Äî app is already installed */
}
#toast{position:fixed;bottom:max(80px,calc(env(safe-area-inset-bottom) + 70px));left:50%;transform:translateX(-50%) translateY(40px);background:var(--text);color:#fff;padding:12px 22px;border-radius:30px;font-size:13px;font-weight:600;z-index:9999;transition:transform .35s cubic-bezier(.23,1,.32,1),opacity .35s;box-shadow:0 6px 24px rgba(0,0,0,.22);white-space:nowrap;opacity:0;pointer-events:none}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}
#toast.success{background:var(--green)}#toast.error{background:var(--red)}#toast.info{background:var(--primary)}
</style>

<!-- ‚ïê‚ïê Firebase COMPAT SDK ‚Äî multi-CDN fallback loader ‚ïê‚ïê
     CDN priority: jsDelivr ‚Üí unpkg ‚Üí gstatic (original)
     All three serve identical Firebase 10.14.1 compat builds.
‚ïê‚ïê -->
<script>
var auth, db;

// ‚îÄ‚îÄ CDN source lists (tried in order) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _FB_VER = '10.14.1';
var _FB_CDNS = [
  'https://cdn.jsdelivr.net/npm/firebase@' + _FB_VER + '/firebase-',
  'https://unpkg.com/firebase@'            + _FB_VER + '/firebase-',
  'https://www.gstatic.com/firebasejs/'    + _FB_VER + '/firebase-'
];
var _FB_PKGS = ['app-compat', 'auth-compat', 'firestore-compat'];

// Track state
var _fbCdnIdx   = 0;   // which CDN we're currently trying
var _fbLoaded   = 0;   // how many scripts loaded OK from current CDN
var _fbFailed   = 0;   // how many scripts errored on current CDN

function _fbSuffix(cdn) {
  // gstatic uses a different path structure: firebase-x-compat.js (no trailing -)
  // jsdelivr/unpkg use: firebase-x-compat.js too, path already has trailing -
  return (cdn.indexOf('gstatic') !== -1)
    ? cdn.replace(/firebase-$/, '') // strip the trailing dash for gstatic
    : cdn;
}

function _fbScriptUrl(cdnBase, pkg) {
  if (cdnBase.indexOf('gstatic') !== -1) {
    // gstatic: https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js
    return 'https://www.gstatic.com/firebasejs/' + _FB_VER + '/firebase-' + pkg + '.js';
  }
  // jsdelivr / unpkg: https://cdn.jsdelivr.net/npm/firebase@10.14.1/firebase-app-compat.js
  return cdnBase + pkg + '.js';
}

function _fbShowError(msg) {
  var el  = document.getElementById('splash-sub');
  var btn = document.getElementById('splash-retry');
  if (el)  { el.textContent = msg; el.style.color = '#ef4444'; }
  if (btn) btn.style.display = 'inline-block';
}

// Load all three scripts from a given CDN index
function _fbLoadCDN(cdnIdx) {
  if (cdnIdx >= _FB_CDNS.length) {
    // All CDNs exhausted
    console.error('[SpendTrack] All Firebase CDNs failed. No internet or all blocked.');
    _fbShowError('Cannot load Firebase ‚Äî check your internet connection and refresh.');
    return;
  }

  _fbLoaded = 0;
  _fbFailed = 0;
  var base   = _FB_CDNS[cdnIdx];
  var names  = ['CDN ' + (cdnIdx + 1), 'jsDelivr', 'unpkg', 'gstatic'];
  console.log('[SpendTrack] Trying Firebase from', names[cdnIdx + 1] || base);

  _FB_PKGS.forEach(function(pkg) {
    var s   = document.createElement('script');
    s.src   = _fbScriptUrl(base, pkg);
    s.async = false; // maintain load order

    s.onload = function() {
      _fbLoaded++;
      if (_fbLoaded === _FB_PKGS.length) {
        // All three scripts from this CDN loaded ‚Äî initialise Firebase
        console.log('[SpendTrack] Firebase SDK loaded successfully.');
        _fbInit();
      }
    };

    s.onerror = function() {
      _fbFailed++;
      console.warn('[SpendTrack] Failed to load', s.src, '‚Äî trying next CDN‚Ä¶');
      if (_fbFailed === 1) {
        // First failure from this CDN ‚Äî abandon and try next CDN
        // Remove any scripts already injected from this CDN to stay clean
        document.querySelectorAll('script[data-fb-cdn="' + cdnIdx + '"]')
          .forEach(function(el){ el.remove(); });
        _fbLoadCDN(cdnIdx + 1);
      }
    };

    s.setAttribute('data-fb-cdn', cdnIdx);
    document.head.appendChild(s);
  });
}

// ‚îÄ‚îÄ Initialise Firebase once SDK is loaded ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _fbInit() {
  try {
    var firebaseConfig = (window.APP_CONFIG && window.APP_CONFIG.firebase) || {};
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db   = firebase.firestore();
    console.log('[SpendTrack] Firebase initialised OK.');
  } catch(e) {
    console.error('[SpendTrack] Firebase init failed:', e);
    _fbShowError('Offline mode. Some features unavailable.');
    document.getElementById('splash').style.display = 'none';
    document.getElementById('auth-screen').style.display = 'flex';
  }
}

// ‚îÄ‚îÄ Kick off ‚Äî start with jsDelivr (index 0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
_fbLoadCDN(0);
</script>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê SPLASH ‚ïê‚ïê‚ïê‚ïê -->
<div id="splash">
  <div class="splash-logo"><img src="Logo.jpg" alt="SpendTrack" style="width:80px;height:80px;border-radius:20px;object-fit:cover;box-shadow:0 4px 20px rgba(79,110,247,.25)"></div>
  <div class="splash-title">Spend Tracker</div>
  <div class="splash-sub" id="splash-sub">Loading‚Ä¶</div>
  <button id="splash-retry" onclick="location.reload()" style="display:none;margin-top:18px;padding:10px 24px;background:var(--primary);color:#fff;border:none;border-radius:20px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;">‚Ü∫ Retry</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo"><img src="Logo.jpg" alt="SpendTrack" style="width:64px;height:64px;border-radius:16px;object-fit:cover;box-shadow:0 4px 16px rgba(79,110,247,.2)"></div>
    <div class="auth-title">Spend Tracker</div>
    <div class="auth-sub">Your personal finance tracker ‚Äî syncs across all devices</div>

    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login" onclick="switchTab('login')">Sign In</button>
      <button class="auth-tab" id="tab-register" onclick="switchTab('register')">Register</button>
    </div>

    <!-- LOGIN FORM -->
    <div id="form-login">
      <div class="fg">
        <label class="flbl">Email</label>
        <input class="fi" type="email" id="login-email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="fg">
        <label class="flbl">Password</label>
        <input class="fi" type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
        <button class="forgot-link" onclick="showForgotPanel()">Forgot password?</button>
      </div>
      <div class="auth-err" id="login-err"></div>
      <button class="btn-primary" id="btn-login" onclick="doLogin()">Sign In ‚Üí</button>
    </div>

    <!-- FORGOT PASSWORD PANEL -->
    <div class="forgot-panel" id="forgot-panel">
      <div class="forgot-title">üîë Reset Password</div>
      <div class="forgot-sub">Enter your email and we'll send you a reset link.</div>

      <!-- Input state -->
      <div id="forgot-input-state">
        <div class="fg">
          <label class="flbl">Email</label>
          <input class="fi" type="email" id="forgot-email" placeholder="you@example.com" autocomplete="email" onkeydown="if(event.key==='Enter')doForgotPassword()">
        </div>
        <div class="auth-err" id="forgot-err"></div>
        <button class="btn-primary" id="btn-forgot" onclick="doForgotPassword()" style="margin-bottom:10px">Send Reset Link ‚Üí</button>
        <button class="back-to-login" onclick="backFromForgot()">‚Üê Back to Sign In</button>
      </div>

      <!-- Success state -->
      <div class="forgot-success" id="forgot-success">
        <div class="forgot-success-icon">üì¨</div>
        <div class="forgot-success-msg">
          Password reset email sent to<br>
          <strong id="forgot-sent-email" style="color:var(--primary)">‚Äî</strong><br><br>
          Click the link in the email to set a new password, then sign in.
        </div>
        <br>
        <button class="back-to-login" onclick="backFromForgot()">‚Üê Back to Sign In</button>
      </div>
    </div>

    <!-- REGISTER FORM -->
    <div id="form-register" style="display:none">
      <div class="fg">
        <label class="flbl">Email</label>
        <input class="fi" type="email" id="reg-email" placeholder="you@example.com" autocomplete="email">
      </div>
      <div class="fg">
        <label class="flbl">Password</label>
        <input class="fi" type="password" id="reg-pass" placeholder="Min 6 characters" autocomplete="new-password">
      </div>
      <div class="fg">
        <label class="flbl">Confirm Password</label>
        <input class="fi" type="password" id="reg-pass2" placeholder="Repeat password" autocomplete="new-password" onkeydown="if(event.key==='Enter')doRegister()">
      </div>
      <div class="auth-err" id="reg-err"></div>
      <button class="btn-primary" id="btn-register" onclick="doRegister()">Create Account ‚Üí</button>
    </div>

    <!-- OTP VERIFICATION PANEL -->
    <div class="verify-panel" id="verify-panel">
      <div class="verify-icon">üîê</div>
      <div class="verify-title">Enter Verification Code</div>
      <div class="verify-msg">We sent a 6-digit code to:</div>
      <div class="verify-email-pill" id="verify-email-pill">‚Äî</div>
      <div class="otp-row" id="otp-row">
        <input class="otp-box" id="otp0" type="text" inputmode="numeric" maxlength="1" pattern="[0-9]" autocomplete="off">
        <input class="otp-box" id="otp1" type="text" inputmode="numeric" maxlength="1" pattern="[0-9]">
        <input class="otp-box" id="otp2" type="text" inputmode="numeric" maxlength="1" pattern="[0-9]">
        <input class="otp-box" id="otp3" type="text" inputmode="numeric" maxlength="1" pattern="[0-9]">
        <input class="otp-box" id="otp4" type="text" inputmode="numeric" maxlength="1" pattern="[0-9]">
        <input class="otp-box" id="otp5" type="text" inputmode="numeric" maxlength="1" pattern="[0-9]">
      </div>
      <div class="otp-err" id="otp-err"></div>
      <div class="otp-timer" id="otp-timer">Code expires in <span id="otp-countdown">15:00</span></div>
      <button class="btn-verify-otp" id="btn-verify-otp" onclick="verifyOtp()">Verify ‚Üí</button>
      <button class="btn-resend" id="btn-resend" onclick="resendOtp()">üîÅ Resend Code</button>
      <div class="resend-ok" id="resend-ok"></div>
      <button class="back-to-login" onclick="backToLogin()">‚Üê Back to Sign In</button>
    </div>

    <div class="auth-footer" id="auth-footer-txt">Your data is private and stored securely in Firebase.<br>Each account has its own isolated data.</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê -->
<div id="app">
  <div class="hdr">
    <div class="hdr-inner">
      <div>
        <div class="brand-sub">Personal Finance</div>
        <div class="brand-name">Spend Tracker</div>
      </div>
      <div class="hdr-r">
        <div class="bico" onclick="showPage('categories')" title="Categories">üè∑Ô∏è</div>
        <div class="bico" onclick="showPage('settings')" title="Settings">‚öôÔ∏è</div>
        <button class="btn-add" onclick="openAddModal()">Ôºã Add</button>
      </div>
    </div>
  </div>
  <div class="scroll-wrap" id="scroll-wrap">
  <!-- APP UPDATE BANNER (shown when a new SW version is ready) -->
  <div id="update-banner">
    <span class="update-txt">üÜï New version available!</span>
    <button class="update-btn" onclick="applyUpdate()">Update now</button>
  </div>

  <div class="sync-bar ok" id="sync-bar">
    <div class="sync-dot"></div>
    <span id="sync-txt">Connected ¬∑ real-time sync active</span>
  </div>

  <!-- DASHBOARD -->
  <div id="page-dashboard" class="page active">
    <div class="bgt-card">
      <div class="bgt-hdr">
        <span class="bgt-title">üí∞ Monthly Budget</span>
        <div class="bgt-iw">
          <span class="bgt-pct" id="bgt-pct" style="color:var(--green)">0%</span>
          <span class="bgt-inp-prefix" style="font-size:10px;color:var(--t3)" id="bgt-curr-sym">Rs.</span>
          <input class="bgt-inp" type="number" id="bgt-inp" value="50000" onchange="saveBudget(this.value)">
        </div>
      </div>
      <div class="bgt-track"><div class="bgt-fill" id="bgt-fill" style="width:0%"></div></div>
      <div class="bgt-footer"><span id="bgt-spent">Rs. 0.00 spent</span><span id="bgt-left">Rs. 0.00 left</span></div>
    </div>
    <div class="stats-toolbar">
      <div class="sc today"><div class="sc-lbl">Today</div><div class="sc-amt" id="stat-today">Rs. 0.00</div><div class="sc-sub" id="stat-today-c">0 entries</div></div>
      <div class="sc month"><div class="sc-lbl">This Month</div><div class="sc-amt" id="stat-month">Rs. 0.00</div><div class="sc-sub" id="stat-month-c">0 entries</div></div>
      <div class="sc avg"><div class="sc-lbl">Daily Avg</div><div class="sc-amt" id="stat-avg">Rs. 0.00</div><div class="sc-sub" id="stat-avg-c">this month</div></div>
      <div class="sc biggest-stat" style="background:linear-gradient(135deg,#f5f3ff,#ede9fe);border:1px solid #ddd6fe;min-width:110px"><div class="sc-lbl" style="color:#7c3aed">Biggest</div><div class="sc-amt" id="stat-biggest" style="color:#5b21b6;font-size:13px">‚Äî</div><div class="sc-sub" id="stat-biggest-cat" style="color:#a78bfa">no entries</div></div>
      <div class="sc trend">
        <div class="sc-lbl">Spending Trend</div>
        <div class="trend-sparkline" id="spark-bars"></div>
        <div class="sc-sub" id="spark-lbl">last 7 days</div>
      </div>
    </div>
    <div id="insights-strip"></div>
    <!-- Desktop + Add button above category section -->
    <div class="sec-add-btn-wrap">
      <button class="btn-add" onclick="openAddModal()" style="position:static;border-radius:12px;padding:10px 20px;font-size:14px;box-shadow:0 4px 14px rgba(79,110,247,.3)">Ôºã Add Expense</button>
    </div>
    <div class="card" id="cat-bd-card" style="margin-bottom:12px;display:none">
      <div class="sec-lbl">This Month by Category</div>
      <div id="cat-bd"></div>
    </div>
    <div>
      <div class="section-hdr">
        <span class="sec-lbl" style="margin:0">Recent Entries</span>
      </div>
      <div id="recent-list" class="elist"></div>
    </div>
  </div>

  <!-- SEARCH -->
  <div id="page-search" class="page">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div class="ftitle" style="margin:0">üîç Search</div>
      <button class="edit-mode-btn" id="edit-mode-btn-srch" onclick="toggleEditMode('srch')">‚úèÔ∏è Edit</button>
    </div>

    <!-- keyword + category row -->
    <div class="fg"><input class="fi" type="text" id="s-text" placeholder="Search item or note‚Ä¶" oninput="renderSearch()"></div>
    <div class="fg"><label class="flbl">Category</label><select class="fi" id="s-cat" onchange="renderSearch()"></select></div>

    <!-- date mode tabs -->
    <div class="date-mode-tabs">
      <button class="dmt active" id="dmt-day"   onclick="setDateMode('day')">üìÖ By Day</button>
      <button class="dmt"        id="dmt-month" onclick="setDateMode('month')">üóì By Month</button>
      <button class="dmt"        id="dmt-year"  onclick="setDateMode('year')">üìÜ By Year</button>
    </div>

    <!-- Day picker -->
    <div id="dp-day" class="fg" style="margin-bottom:10px">
      <label class="flbl">Select Date</label>
      <input class="fi" type="date" id="s-date" onchange="renderSearch()">
    </div>
    <!-- Month picker -->
    <div id="dp-month" class="fg" style="margin-bottom:10px;display:none">
      <label class="flbl">Select Month</label>
      <input class="fi" type="month" id="s-month" onchange="renderSearch()">
    </div>
    <!-- Year picker -->
    <div id="dp-year" class="fg" style="margin-bottom:10px;display:none">
      <label class="flbl">Select Year</label>
      <select class="fi" id="s-year" onchange="renderSearch()"></select>
    </div>

    <button class="clear-btn" onclick="clearSearch()">‚úï Clear Filters</button>
    <div class="srch-count" id="s-count">0 results</div>
    <div id="s-results" class="elist"></div>
    <div class="card srch-total-card" id="s-total-card" style="margin-top:12px;display:none">
      <div class="srch-total-lbl">Search Total</div>
      <div class="srch-total-amt" id="s-total-amt">Rs. 0.00</div>
    </div>
  </div>

  <!-- VIEW ALL (formerly History) -->
  <div id="page-history" class="page">
    <div class="hist-hdr">
      <div class="ftitle" style="margin:0">üìã View All</div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="hist-total" id="hist-total"></div>
        <button class="edit-mode-btn" id="edit-mode-btn-hist" onclick="toggleEditMode('hist')">‚úèÔ∏è Edit</button>
      </div>
    </div>
    <div class="sort-bar">
      <span class="sort-lbl">Sort:</span>
      <button class="sort-btn active" id="sort-new" onclick="setHistSort('new',this)">Newest First</button>
      <button class="sort-btn" id="sort-old" onclick="setHistSort('old',this)">Oldest First</button>
    </div>
    <div id="hist-list" class="elist"></div>
  </div>

  <!-- CATEGORIES -->
  <div id="page-categories" class="page">
    <div class="cats-hdr">
      <div class="ftitle" style="margin:0">üè∑Ô∏è Categories</div>
      <button class="btn-new-cat" onclick="openCatModal()">Ôºã New</button>
    </div>
    <div class="info-box">üí° <b>Edit</b> any category to rename it or change its emoji and colour. Default categories cannot be deleted.</div>
    <div id="cm-list" class="cm-list"></div>
  </div>

  <!-- SETTINGS -->
  <div id="page-settings" class="page">
    <div class="ftitle">‚öôÔ∏è Settings</div>

    <div class="st-section">
      <div class="st-section-title">üë§ Account</div>
      <div class="st-row">
        <div class="st-info">
          <div class="st-label" id="st-email">‚Äî</div>
          <div class="st-sub">Signed in ¬∑ data syncs in real-time</div>
        </div>
        <button class="sbtn red" onclick="doSignOut()">Sign Out</button>
      </div>
    </div>

    <div class="st-section">
      <div class="st-section-title">üí± Currency</div>
      <div class="st-row">
        <div class="st-info">
          <div class="st-label">Display Currency</div>
          <div class="st-sub">All amounts will display in selected currency</div>
        </div>
        <select class="curr-sel" id="currency-sel" onchange="changeCurrency(this.value)">
          <option value="LKR">üá±üá∞ LKR (Rs.)</option>
          <option value="USD">üá∫üá∏ USD ($)</option>
          <option value="EUR">üá™üá∫ EUR (‚Ç¨)</option>
          <option value="GBP">üá¨üáß GBP (¬£)</option>
          <option value="AUD">üá¶üá∫ AUD (A$)</option>
          <option value="CAD">üá®üá¶ CAD (C$)</option>
        </select>
      </div>
    </div>

    <div class="st-section">
      <div class="st-section-title">üì¶ Backup</div>
      <div class="st-row">
        <div class="st-info"><div class="st-label">Export to JSON</div><div class="st-sub">Download a full local backup</div></div>
        <button class="sbtn green" onclick="exportJSON()">‚¨á Export</button>
      </div>
      <div class="st-row">
        <div class="st-info"><div class="st-label">Import from JSON</div><div class="st-sub">Restore or merge a backup file</div></div>
        <button class="sbtn blue" onclick="document.getElementById('import-file').click()">‚¨Ü Import</button>
      </div>
      <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJSON(event)">
    </div>

    <div class="st-section">
      <div class="st-section-title">‚ö†Ô∏è Danger Zone</div>
      <div class="st-row">
        <div class="st-info">
          <div class="st-label">Clear All Entries</div>
          <div class="st-sub">Permanently deletes every record ‚Äî cannot be undone</div>
        </div>
        <button class="sbtn red" onclick="openDangerModal()">üóë Clear</button>
      </div>
    </div>

    <div style="font-size:11px;color:var(--t3);text-align:center;padding:10px 0 4px">Spend Tracker ¬∑ Menan</div>
  </div>

  </div><!-- /scroll-wrap -->
  <nav class="bnav">
    <button class="nbtn active" id="nav-dashboard" onclick="showPage('dashboard')"><span class="n-icon">üè†</span><span class="n-lbl">Home</span></button>
    <button class="nbtn" id="nav-search" onclick="showPage('search')"><span class="n-icon">üîç</span><span class="n-lbl">Search</span></button>
    <button class="nbtn" id="nav-history" onclick="showPage('history')"><span class="n-icon">üìã</span><span class="n-lbl">View All</span></button>
  </nav>
</div>

<!-- DANGER CONFIRM MODAL -->
<div class="danger-overlay" id="modal-danger">
  <div class="danger-box">
    <div class="danger-icon">üóëÔ∏è</div>
    <div class="danger-title">Delete All Entries?</div>
    <div class="danger-sub">This will permanently erase <strong id="danger-count">0 entries</strong>.<br>This action <strong>cannot be undone</strong>.</div>
    <div class="danger-confirm-row">
      <label class="danger-confirm-lbl">Type <strong style="color:#ef4444;letter-spacing:2px">DELETE</strong> to confirm</label>
      <input class="danger-inp" type="text" id="danger-inp" placeholder="DELETE" oninput="checkDangerInput(this)" autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
    <div class="danger-btns">
      <button class="danger-cancel" onclick="closeDangerModal()">Cancel</button>
      <button class="danger-confirm" id="danger-confirm-btn" onclick="confirmClearAll()" disabled>Delete All</button>
    </div>
  </div>
</div>

<!-- SCROLL TO TOP -->
<button id="scroll-top-btn" onclick="scrollToTop()" title="Back to top">‚Üë</button>

<script>
// ‚îÄ‚îÄ‚îÄ SCROLL-TO-TOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var scrollWrap = document.getElementById('scroll-wrap');
var scrollTopBtn = document.getElementById('scroll-top-btn');
if (scrollWrap && scrollTopBtn) {
  scrollWrap.addEventListener('scroll', function() {
    scrollTopBtn.classList.toggle('visible', scrollWrap.scrollTop > 200);
  }, { passive: true });
}
function scrollToTop() {
  if (scrollWrap) scrollWrap.scrollTo({ top: 0, behavior: 'smooth' });
}

// ‚îÄ‚îÄ‚îÄ HAPTIC FEEDBACK (Android vibrate API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function haptic(ms) {
  try { if (navigator.vibrate) navigator.vibrate(ms || 30); } catch(e) {}
}
// Patch buttons for subtle haptic
document.addEventListener('click', function(e) {
  var t = e.target;
  if (t.classList.contains('btn-save') || t.classList.contains('btn-add') || 
      t.id === 'danger-confirm-btn') {
    haptic(40);
  } else if (t.classList.contains('nbtn') || t.classList.contains('ibtn')) {
    haptic(15);
  }
}, { passive: true });
</script>
<div class="overlay" id="modal-exp" onclick="closeBg(event,'modal-exp')">
  <div class="mbox">
    <div class="mhandle"></div>
    <div class="ftitle" id="exp-title">üí∏ Add Expense</div>
    <input type="hidden" id="edit-id">
    <div class="fg"><label class="flbl">Item Name</label><input class="fi" type="text" id="form-item" placeholder="e.g. Rice & Curry, Tuk Tuk..."></div>
    <div class="frow">
      <div class="fg"><label class="flbl" id="amount-lbl">Amount (Rs.)</label><div class="amt-wrap"><span class="amt-prefix" id="amt-prefix-sym">Rs.</span><input class="fi" type="text" inputmode="decimal" id="form-amount" placeholder="0.00" oninput="formatAmountInput(this)" onblur="finalizeAmount(this)"></div></div>
      <div class="fg"><label class="flbl">Date</label><input class="fi" type="date" id="form-date"></div>
    </div>
    <div class="fg"><label class="flbl">Category</label><input class="cat-search" type="text" id="cat-search" placeholder="üîç  Filter categories‚Ä¶" oninput="buildCatPicker()"><div class="cat-grid-wrap"><div class="cat-grid" id="cat-picker"></div></div></div>
    <div class="fg"><label class="flbl">Note (optional)</label><textarea class="fi" id="form-note" rows="2" placeholder="Add a short note..." style="resize:none"></textarea></div>
    <div class="fbtns">
      <button class="btn-cancel" onclick="closeModal('modal-exp')">Cancel</button>
      <button class="btn-save" onclick="saveEntry()">Save Expense</button>
    </div>
  </div>
</div>

<!-- CATEGORY MODAL -->
<div class="overlay" id="modal-cat" onclick="closeBg(event,'modal-cat')">
  <div class="mbox">
    <div class="mhandle"></div>
    <div class="ftitle" id="cat-title">‚ú® New Category</div>
    <input type="hidden" id="cat-edit-id">
    <div class="cat-form-row">
      <div>
        <input class="emoji-inp" type="text" id="cat-emoji" maxlength="2" placeholder="üòÄ" oninput="updatePreview()">
        <div class="emoji-hint">Type any emoji</div>
      </div>
      <div class="fg" style="margin:0"><label class="flbl">Category Name</label><input class="fi" type="text" id="cat-name" placeholder="e.g. Groceries" oninput="updatePreview()"></div>
    </div>
    <div class="fg">
      <label class="flbl">Colour</label>
      <div class="color-grid" id="color-grid"></div>
      <div class="custom-color-row">
        <span class="custom-color-lbl">Custom:</span>
        <input type="color" id="custom-color" value="#4f6ef7" oninput="pickCustomColor(this.value)">
        <span style="font-size:12px;color:var(--t3)">pick any colour</span>
      </div>
      <div class="color-preview">
        <div class="preview-dot" id="preview-dot" style="background:#4f6ef7"></div>
        <span id="preview-text" style="font-weight:700;font-size:14px;color:#4f6ef7">‚≠ê Preview</span>
      </div>
    </div>
    <div class="fbtns">
      <button class="btn-cancel" onclick="closeModal('modal-cat')">Cancel</button>
      <button class="btn-save" onclick="saveCat()">Save Category</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN SCRIPT  (global scope ‚Äî compat-safe)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_CATS = [
  {id:'food',      name:'Food',          icon:'üçî', color:'#ef4444', isDefault:true},
  {id:'transport', name:'Transport',     icon:'üöå', color:'#f97316', isDefault:true},
  {id:'shopping',  name:'Shopping',      icon:'üõçÔ∏è', color:'#eab308', isDefault:true},
  {id:'bills',     name:'Bills',         icon:'‚ö°', color:'#8b5cf6', isDefault:true},
  {id:'health',    name:'Health',        icon:'üíä', color:'#10b981', isDefault:true},
  {id:'entertain', name:'Entertainment', icon:'üéÆ', color:'#ec4899', isDefault:true},
  {id:'education', name:'Education',     icon:'üìö', color:'#3b82f6', isDefault:true},
  {id:'other',     name:'Other',         icon:'üì¶', color:'#6b7280', isDefault:true},
];
const PRESET_COLORS = [
  '#ef4444','#f97316','#eab308','#22c55e',
  '#10b981','#14b8a6','#3b82f6','#6366f1',
  '#8b5cf6','#ec4899','#f43f5e','#64748b',
  '#0ea5e9','#a855f7','#d97706','#6b7280'
];

const CURRENCIES = {
  LKR: { symbol:'Rs.', locale:'en-LK', name:'Sri Lankan Rupee' },
  USD: { symbol:'$',   locale:'en-US', name:'US Dollar' },
  EUR: { symbol:'‚Ç¨',   locale:'de-DE', name:'Euro' },
  GBP: { symbol:'¬£',   locale:'en-GB', name:'British Pound' },
  AUD: { symbol:'A$',  locale:'en-AU', name:'Australian Dollar' },
  CAD: { symbol:'C$',  locale:'en-CA', name:'Canadian Dollar' }
};

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var currentUser   = null;
var entries       = [];
var categories    = JSON.parse(JSON.stringify(DEFAULT_CATS));
var budget        = 50000;
var chartPeriod   = 7;
var selectedCat   = 'food';
var selColor      = '#4f6ef7';
var unsubEntries  = null;
var unsubSettings = null;
var trendVisible  = localStorage.getItem('trendVisible') !== 'false';
var editMode      = false;
var currency      = localStorage.getItem('currency') || 'LKR';
var dateMode      = 'day';   // 'day' | 'month' | 'year'
var histSort      = 'new';   // 'new' | 'old'

// ‚îÄ‚îÄ‚îÄ FIRESTORE PATHS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function userDoc()     { return db.collection('users').doc(currentUser.uid); }
function entriesCol()  { return userDoc().collection('entries'); }
function settingsDoc() { return userDoc().collection('settings').doc('main'); }

// ‚îÄ‚îÄ‚îÄ OTP STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Keys are loaded from config.js ‚Üí window.APP_CONFIG.emailjs
var EMAILJS_CONFIG = (window.APP_CONFIG && window.APP_CONFIG.emailjs) || {};
// OTP template variables used: {{passcode}}, {{time}}, {{to_email}}
// Reset template variables used: {{link}}, {{email}}
var _emailJsReady = false;
// EmailJS is initialized after window load to guarantee the SDK script has run
window.addEventListener('load', function() {
  if (window._emailJsLoadFailed) {
    console.error('[SpendTrack] EmailJS SDK failed to load from CDN.');
    return;
  }
  try {
    if (typeof emailjs !== 'undefined') {
      emailjs.init({ publicKey: EMAILJS_CONFIG.publicKey });
      _emailJsReady = true;
      console.log('[SpendTrack] EmailJS ready. Service:', EMAILJS_CONFIG.serviceId);
    } else {
      console.error('[SpendTrack] emailjs is undefined after load.');
    }
  } catch(e) {
    console.error('[SpendTrack] EmailJS init threw:', e);
  }
});

// ‚îÄ‚îÄ‚îÄ OTP STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _otpMode           = null;   // 'register' | 'login'
var _pendingEmail      = null;   // email waiting for OTP confirmation
var _pendingPassword   = null;   // password held only until account created / re-auth
var _pendingLoginUser  = null;   // Firebase user object (login-OTP flow only)
var _currentOtpCode    = null;   // 6-digit code held in memory
var _otpExpiry         = 0;      // Unix ms expiry
var _otpCountdownTimer = null;
var _otpResendCooldown = null;
var _authFlowInProgress = false; // blocks onAuthStateChanged during login-OTP flow

// ‚îÄ‚îÄ‚îÄ AUTH TAB SWITCHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.getElementById('form-login').style.display    = tab === 'login'    ? 'block' : 'none';
  document.getElementById('form-register').style.display = tab === 'register' ? 'block' : 'none';
  document.getElementById('tab-login').classList.toggle('active',    tab === 'login');
  document.getElementById('tab-register').classList.toggle('active', tab === 'register');
  document.getElementById('forgot-panel').classList.remove('show');
  document.getElementById('login-err').textContent = '';
  document.getElementById('reg-err').textContent   = '';
}

// ‚îÄ‚îÄ‚îÄ REGISTER: OTP-FIRST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Step 1 of 2: Validate ‚Üí Send OTP ‚Üí Show OTP panel
// Firebase account is NOT created until the code is confirmed.
function doRegister() {
  var email  = document.getElementById('reg-email').value.trim();
  var pass   = document.getElementById('reg-pass').value;
  var pass2  = document.getElementById('reg-pass2').value;
  var errEl  = document.getElementById('reg-err');
  var btn    = document.getElementById('btn-register');
  errEl.textContent = '';

  if (!email || !pass)  { errEl.textContent = 'Please fill all fields.'; return; }
  if (pass.length < 6)  { errEl.textContent = 'Password must be at least 6 characters.'; return; }
  if (pass !== pass2)   { errEl.textContent = 'Passwords do not match.'; return; }

  btn.disabled = true; btn.textContent = 'Sending code‚Ä¶';
  _authFlowInProgress = true; // block onAuthStateChanged for the entire OTP flow

  _otpMode        = 'register';
  _pendingEmail   = email;
  _pendingPassword = pass;

  sendOtpEmail(email)
    .then(function() {
      btn.disabled = false; btn.textContent = 'Create Account ‚Üí';
      showOtpPanel(email);
    })
    .catch(function(err) {
      _authFlowInProgress = false;
      btn.disabled = false; btn.textContent = 'Create Account ‚Üí';
      var detail = (err && err.text) ? err.text : (err && err.message ? err.message : String(err));
      errEl.textContent = 'Could not send code: ' + detail + '. Please try again.';
      console.error('[SpendTrack] Registration OTP send failed:', err);
    });
}

// Step 2 of 2 (called from verifyOtp on correct code):
// Create the Firebase account, write verified flag, sign back out, show success.
function completeRegistration() {
  var btn = document.getElementById('btn-verify-otp');
  btn.disabled = true; btn.textContent = 'Creating account‚Ä¶';
  _authFlowInProgress = true;

  auth.createUserWithEmailAndPassword(_pendingEmail, _pendingPassword)
    .then(function(cred) {
      // Write the verified flag to Firestore only.
      // We deliberately do NOT set localStorage here ‚Äî if we did, a delayed
      // onAuthStateChanged(user) callback on mobile would see the flag and
      // auto-enter the app without the user signing in explicitly.
      // localStorage gets set on the first successful doLogin() call.
      return db.collection('users').doc(cred.user.uid)
               .collection('settings').doc('main')
               .set({ sptrackEmailVerified: true }, { merge: true })
               .catch(function() {
                 // Firestore blocked (ad-blocker etc.) ‚Äî that's OK.
                 // doLogin's Firestore check will also fail gracefully and
                 // fall back to the OTP re-verify flow on first login.
                 console.warn('[SpendTrack] Firestore verified-flag write failed during registration.');
               })
               .then(function() { return auth.signOut(); });
    })
    .then(function() {
      // Keep _authFlowInProgress = true throughout all UI transitions.
      // Only release it at the very end so no delayed onAuthStateChanged
      // callback can sneak through and auto-enter the app on mobile.
      clearOtpState();
      hideOtpPanel();
      // Clear all signup fields immediately
      document.getElementById('reg-email').value = '';
      document.getElementById('reg-pass').value  = '';
      document.getElementById('reg-pass2').value = '';
      document.getElementById('reg-err').textContent = '';
      document.querySelector('.auth-tabs').style.display = '';
      document.getElementById('auth-footer-txt').style.display = '';
      switchTab('login');
      var errEl = document.getElementById('login-err');
      errEl.style.color = 'var(--green)';
      errEl.textContent = 'üéâ Account created! Please sign in to continue.';
      setTimeout(function() { errEl.style.color = ''; errEl.textContent = ''; }, 8000);
      // Release the guard LAST ‚Äî all UI is now settled on the login screen.
      _authFlowInProgress = false;
    })
    .catch(function(e) {
      _authFlowInProgress = false;
      btn.disabled = false; btn.textContent = 'Verify ‚Üí';
      if (e.code === 'auth/email-already-in-use') {
        showOtpError('An account already exists with this email. Please sign in instead.');
      } else {
        showOtpError('Account creation failed: ' + (e.message || e.code));
      }
      console.error('[SpendTrack] completeRegistration error:', e);
    });
}

// ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doLogin() {
  var email = document.getElementById('login-email').value.trim();
  var pass  = document.getElementById('login-pass').value;
  var errEl = document.getElementById('login-err');
  var btn   = document.getElementById('btn-login');
  errEl.textContent = ''; errEl.style.color = '';
  if (!email || !pass) { errEl.textContent = 'Please enter email and password.'; return; }

  btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
  _authFlowInProgress = true;

  auth.signInWithEmailAndPassword(email, pass)
    .then(function(cred) {
      // Fast path: Firebase-native verified OR localStorage flag
      var localVerified = false;
      try { localVerified = localStorage.getItem('sptrack_ev_' + cred.user.uid) === '1'; } catch(e) {}
      if (cred.user.emailVerified || localVerified) {
        btn.disabled = false; btn.textContent = 'Sign In ‚Üí';
        _enterApp(cred.user);
        return;
      }

      // Slow path: check Firestore for verified flag (cross-device)
      // Wrap in its own catch so Firestore failures (ad-blocker etc.) don't
      // bubble up to the outer catch as "Error: undefined".
      return db.collection('users').doc(cred.user.uid)
               .collection('settings').doc('main').get()
        .then(function(snap) {
          if (snap.exists && snap.data().sptrackEmailVerified === true) {
            try { localStorage.setItem('sptrack_ev_' + cred.user.uid, '1'); } catch(e) {}
            btn.disabled = false; btn.textContent = 'Sign In ‚Üí';
            _enterApp(cred.user);
            return;
          }
          // Not verified ‚Äî go to OTP flow
          return _startLoginOtp(cred.user, email, pass, btn);
        })
        .catch(function(firestoreErr) {
          // Firestore is blocked (ad-blocker / offline) ‚Äî fall back to OTP flow
          console.warn('[SpendTrack] Firestore verification check failed, falling back to OTP:', firestoreErr.message || firestoreErr);
          return _startLoginOtp(cred.user, email, pass, btn);
        });
    })
    .catch(function(e) {
      // Only Firebase Auth errors reach here (wrong password, user not found, etc.)
      _authFlowInProgress = false;
      var msg = (e && e.code) ? friendlyAuthError(e.code) : (e && e.message ? e.message : 'Sign-in failed. Please try again.');
      errEl.textContent = msg;
      btn.disabled = false; btn.textContent = 'Sign In ‚Üí';
    });
}

// Extracted helper: kick off OTP verification for an unverified login
function _startLoginOtp(firebaseUser, email, pass, btn) {
  _otpMode          = 'login';
  _pendingEmail     = email;
  _pendingPassword  = pass;
  _pendingLoginUser = firebaseUser;
  btn.disabled = false; btn.textContent = 'Sign In ‚Üí';

  return sendOtpEmail(email, firebaseUser.uid)
    .then(function() { return auth.signOut(); })
    .then(function() {
      showOtpPanel(email);
      // Keep _authFlowInProgress = true until OTP panel is fully shown so
      // onAuthStateChanged(null) doesn't reset the auth screen behind us.
      // It gets cleared by clearOtpState() ‚Üí backToLogin() or completeLogin().
    })
    .catch(function(err) {
      var detail = (err && err.text) ? err.text : (err && err.message ? err.message : String(err));
      return auth.signOut().then(function() {
        showOtpPanel(email, '‚ö†Ô∏è Email failed: ' + detail + ' ‚Äî tap Resend Code.');
      });
    });
}

// ‚îÄ‚îÄ‚îÄ COMPLETE LOGIN (called from verifyOtp on correct code) ‚îÄ‚îÄ‚îÄ
function completeLogin() {
  var btn = document.getElementById('btn-verify-otp');
  btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
  _authFlowInProgress = true;

  auth.signInWithEmailAndPassword(_pendingEmail, _pendingPassword)
    .then(function(cred) {
      // Save verified flag to localStorage immediately (Firestore may be blocked)
      try { localStorage.setItem('sptrack_ev_' + cred.user.uid, '1'); } catch(e) {}
      // Also try Firestore but don't block on failure
      db.collection('users').doc(cred.user.uid)
        .collection('settings').doc('main')
        .set({ sptrackEmailVerified: true }, { merge: true })
        .catch(function() {
          console.warn('[SpendTrack] Firestore verified-flag write failed; localStorage fallback active.');
        });
      return cred.user;
    })
    .then(function(user) {
      clearOtpState();
      _enterApp(user); // call directly ‚Äî don't rely on onAuthStateChanged re-firing
    })
    .catch(function(e) {
      _authFlowInProgress = false;
      btn.disabled = false; btn.textContent = 'Verify ‚Üí';
      showOtpError('Sign-in failed: ' + (e.message || e.code) + '. Please go back and try again.');
      console.error('[SpendTrack] completeLogin error:', e);
    });
}

// ‚îÄ‚îÄ‚îÄ SEND OTP EMAIL (pure EmailJS, no Firebase dependency) ‚îÄ‚îÄ‚îÄ‚îÄ
function sendOtpEmail(email, uid) {
  _currentOtpCode = String(Math.floor(100000 + Math.random() * 900000));
  _otpExpiry      = Date.now() + 15 * 60 * 1000;

  var expiryTime = new Date(_otpExpiry).toLocaleTimeString('en-US', {
    hour: 'numeric', minute: '2-digit', hour12: true
  });

  console.log('[SpendTrack] Sending OTP to', email, '| code:', _currentOtpCode, '| expires:', expiryTime);

  if (!_emailJsReady) {
    console.warn('[SpendTrack] EmailJS not ready ‚Äî test mode, code shown on screen.');
    return Promise.resolve(); // caller shows panel; test code shown inside panel
  }

  return emailjs.send(
    EMAILJS_CONFIG.serviceId,
    EMAILJS_CONFIG.otpTemplateId,
    { to_email: email, passcode: _currentOtpCode, time: expiryTime }
  ).then(function(res) {
    console.log('[SpendTrack] OTP email sent OK:', res.status, res.text);
  }).catch(function(err) {
    console.error('[SpendTrack] EmailJS failed:', JSON.stringify(err));
    throw err; // re-throw so caller catches and shows error
  });
}

// ‚îÄ‚îÄ‚îÄ RESEND OTP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resendOtp() {
  var btn  = document.getElementById('btn-resend');
  var okEl = document.getElementById('resend-ok');
  if (!_pendingEmail) { backToLogin(); return; }

  btn.disabled = true;
  clearOtpBoxes();
  document.getElementById('otp-err').textContent = '';
  okEl.textContent = ''; okEl.style.color = '';
  document.getElementById('btn-verify-otp').disabled = false;
  document.getElementById('btn-verify-otp').textContent = 'Verify ‚Üí';

  // For login mode, resend needs auth ‚Äî sign in temporarily, send, sign back out
  var sendPromise;
  if (_otpMode === 'login' && _pendingEmail && _pendingPassword) {
    sendPromise = auth.signInWithEmailAndPassword(_pendingEmail, _pendingPassword)
      .then(function(cred) {
        _pendingLoginUser = cred.user;
        return sendOtpEmail(_pendingEmail, cred.user.uid);
      })
      .then(function() { return auth.signOut(); });
  } else {
    sendPromise = sendOtpEmail(_pendingEmail);
  }

  sendPromise
    .then(function() {
      startOtpCountdown();
      okEl.style.color = 'var(--green)';
      okEl.textContent = '‚úì New code sent! Check your inbox.';
      setTimeout(function() { okEl.textContent = ''; }, 4000);
      var cooldown = 30;
      clearInterval(_otpResendCooldown);
      _otpResendCooldown = setInterval(function() {
        cooldown--;
        btn.textContent = 'üîÅ Resend Code (' + cooldown + 's)';
        if (cooldown <= 0) {
          clearInterval(_otpResendCooldown);
          btn.textContent = 'üîÅ Resend Code';
          btn.disabled = false;
        }
      }, 1000);
      btn.textContent = 'üîÅ Resend Code (30s)';
      if (!_emailJsReady) {
        document.getElementById('otp-err').innerHTML =
          '‚ö†Ô∏è EmailJS not ready. Test code: <b style="font-family:monospace;font-size:15px;color:var(--primary);letter-spacing:2px">' + _currentOtpCode + '</b>';
      }
    })
    .catch(function(err) {
      var detail = (err && err.text) ? err.text : (err && err.message ? err.message : String(err));
      document.getElementById('otp-err').textContent = '‚ö†Ô∏è Failed to send: ' + detail;
      btn.disabled = false; btn.textContent = 'üîÅ Resend Code';
    });
}

// ‚îÄ‚îÄ‚îÄ VERIFY OTP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function verifyOtp() {
  var entered = getOtpValue();
  if (entered.length < 6) return;

  var btn = document.getElementById('btn-verify-otp');
  btn.disabled = true; btn.textContent = 'Verifying‚Ä¶';

  if (!_currentOtpCode) {
    showOtpError('Session lost. Please go back and start again.');
    btn.disabled = false; btn.textContent = 'Verify ‚Üí';
    return;
  }
  if (Date.now() > _otpExpiry) {
    showOtpError('Code has expired. Tap "Resend Code" for a new one.');
    btn.disabled = false; btn.textContent = 'Verify ‚Üí';
    return;
  }
  if (entered !== _currentOtpCode) {
    showOtpError('Incorrect code ‚Äî try again.');
    btn.disabled = false; btn.textContent = 'Verify ‚Üí';
    return;
  }

  // ‚úÖ Code correct ‚Äî branch on mode
  if (_otpMode === 'register') {
    completeRegistration();
  } else {
    completeLogin();
  }
}

// ‚îÄ‚îÄ‚îÄ OTP UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showOtpPanel(email, errorMsg) {
  document.getElementById('form-login').style.display    = 'none';
  document.getElementById('form-register').style.display = 'none';
  document.getElementById('tab-login').classList.remove('active');
  document.getElementById('tab-register').classList.remove('active');
  document.getElementById('auth-footer-txt').style.display = 'none';
  document.querySelector('.auth-tabs').style.display = 'none';
  document.getElementById('verify-email-pill').textContent = email;
  document.getElementById('otp-err').textContent   = errorMsg || (!_emailJsReady
    ? '‚ö†Ô∏è EmailJS not ready. Test code: ' + _currentOtpCode : '');
  document.getElementById('resend-ok').textContent = '';
  document.getElementById('btn-resend').disabled   = false;
  document.getElementById('btn-verify-otp').disabled = false;
  document.getElementById('btn-verify-otp').textContent = 'Verify ‚Üí';
  clearOtpBoxes();
  document.getElementById('verify-panel').classList.add('show');
  startOtpCountdown();
  initOtpBoxes();
  setTimeout(function() { document.getElementById('otp0').focus(); }, 150);
}

function initOtpBoxes() {
  var boxes = document.querySelectorAll('.otp-box');
  boxes.forEach(function(box, i) {
    box.oninput = function(e) {
      var val = e.target.value.replace(/\D/g, '');
      e.target.value = val ? val[val.length - 1] : '';
      e.target.classList.toggle('filled', !!e.target.value);
      clearOtpError();
      if (val && i < 5) boxes[i + 1].focus();
      if (getOtpValue().length === 6) verifyOtp();
    };
    box.onkeydown = function(e) {
      if (e.key === 'Backspace' && !e.target.value && i > 0) {
        boxes[i - 1].value = '';
        boxes[i - 1].classList.remove('filled');
        boxes[i - 1].focus();
      }
      if (e.key === 'Enter') verifyOtp();
    };
    box.onpaste = function(e) {
      e.preventDefault();
      var pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, 6);
      pasted.split('').forEach(function(ch, j) {
        if (boxes[j]) { boxes[j].value = ch; boxes[j].classList.add('filled'); }
      });
      if (pasted.length === 6) { boxes[5].focus(); verifyOtp(); }
      else if (boxes[pasted.length]) boxes[pasted.length].focus();
    };
  });
}

function getOtpValue() {
  return Array.from(document.querySelectorAll('.otp-box')).map(function(b){ return b.value; }).join('');
}

function clearOtpBoxes() {
  document.querySelectorAll('.otp-box').forEach(function(b) {
    b.value = ''; b.classList.remove('filled', 'error');
  });
}

function clearOtpError() {
  document.getElementById('otp-err').textContent = '';
  document.querySelectorAll('.otp-box').forEach(function(b) { b.classList.remove('error'); });
}

function showOtpError(msg) {
  document.getElementById('otp-err').textContent = msg;
  document.querySelectorAll('.otp-box').forEach(function(b) { b.classList.add('error'); });
  setTimeout(function() { clearOtpBoxes(); document.getElementById('otp0').focus(); }, 600);
}

function startOtpCountdown() {
  clearInterval(_otpCountdownTimer);
  var timerEl     = document.getElementById('otp-timer');
  var countdownEl = document.getElementById('otp-countdown');
  timerEl.innerHTML = 'Code expires in <span id="otp-countdown">15:00</span>';
  _otpCountdownTimer = setInterval(function() {
    var remaining = Math.max(0, _otpExpiry - Date.now());
    var m = Math.floor(remaining / 60000);
    var s = Math.floor((remaining % 60000) / 1000);
    var el = document.getElementById('otp-countdown');
    if (el) el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
    if (remaining === 0) {
      clearInterval(_otpCountdownTimer);
      if (timerEl) timerEl.textContent = 'Code expired ‚Äî tap Resend Code.';
      document.getElementById('btn-verify-otp').disabled = true;
    }
  }, 1000);
}

function clearOtpState() {
  clearInterval(_otpCountdownTimer);
  clearInterval(_otpResendCooldown);
  _otpMode          = null;
  _pendingEmail     = null;
  _pendingPassword  = null;
  _pendingLoginUser = null;
  _currentOtpCode   = null;
  _otpExpiry        = 0;
}

function hideOtpPanel() {
  document.getElementById('verify-panel').classList.remove('show');
}

function backToLogin() {
  clearOtpState();
  _authFlowInProgress = false;
  hideOtpPanel();
  document.querySelector('.auth-tabs').style.display = '';
  document.getElementById('auth-footer-txt').style.display = '';
  switchTab('login');
}

// ‚îÄ‚îÄ‚îÄ SIGN OUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doSignOut() {
  if (!confirm('Sign out of SpendTrack?')) return;
  stopListeners();
  auth.signOut();
}

// ‚îÄ‚îÄ‚îÄ FORGOT PASSWORD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showForgotPanel() {
  document.getElementById('form-login').style.display = 'none';
  document.getElementById('tab-login').classList.remove('active');
  document.getElementById('tab-register').classList.remove('active');
  document.querySelector('.auth-tabs').style.display = 'none';
  document.getElementById('auth-footer-txt').style.display = 'none';
  document.getElementById('forgot-input-state').style.display = 'block';
  document.getElementById('forgot-success').classList.remove('show');
  document.getElementById('forgot-err').textContent = '';
  // Pre-fill email if already typed in login form
  var loginEmail = document.getElementById('login-email').value.trim();
  if (loginEmail) document.getElementById('forgot-email').value = loginEmail;
  document.getElementById('forgot-panel').classList.add('show');
  setTimeout(function() { document.getElementById('forgot-email').focus(); }, 150);
}

function backFromForgot() {
  document.getElementById('forgot-panel').classList.remove('show');
  document.querySelector('.auth-tabs').style.display = '';
  document.getElementById('auth-footer-txt').style.display = '';
  document.getElementById('form-login').style.display = 'block';
  document.getElementById('tab-login').classList.add('active');
  document.getElementById('btn-forgot').disabled = false;
  document.getElementById('btn-forgot').textContent = 'Send Reset Link ‚Üí';
}

function doForgotPassword() {
  var email = document.getElementById('forgot-email').value.trim();
  var errEl = document.getElementById('forgot-err');
  var btn   = document.getElementById('btn-forgot');
  errEl.textContent = ''; errEl.style.color = '';
  if (!email) { errEl.textContent = 'Please enter your email address.'; return; }
  btn.disabled = true; btn.textContent = 'Sending‚Ä¶';

  auth.sendPasswordResetEmail(email)
    .then(function() {
      // Show success state
      document.getElementById('forgot-sent-email').textContent = email;
      document.getElementById('forgot-input-state').style.display = 'none';
      document.getElementById('forgot-success').classList.add('show');
    })
    .catch(function(e) {
      var msgs = {
        'auth/user-not-found': 'No account found with that email.',
        'auth/invalid-email':  'Please enter a valid email address.',
        'auth/too-many-requests': 'Too many requests. Please try again later.'
      };
      errEl.textContent = msgs[e.code] || 'Could not send reset email. Please try again.';
      btn.disabled = false; btn.textContent = 'Send Reset Link ‚Üí';
    });
}

// ‚îÄ‚îÄ‚îÄ AUTH ERROR MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function friendlyAuthError(code) {
  var map = {
    'auth/user-not-found':      'No account found with that email.',
    'auth/wrong-password':      'Incorrect password.',
    'auth/invalid-email':       'Please enter a valid email address.',
    'auth/email-already-in-use':'An account already exists with that email.',
    'auth/weak-password':       'Password must be at least 6 characters.',
    'auth/invalid-credential':  'Incorrect email or password.',
    'auth/too-many-requests':   'Too many attempts. Please wait a moment.'
  };
  return map[code] || 'Error: ' + code;
}

// ‚îÄ‚îÄ‚îÄ AUTH STATE LISTENER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _authResolved = false;
var _splashTimeout = setTimeout(function() {
  if (!_authResolved) {
    var sub = document.getElementById('splash-sub');
    var btn = document.getElementById('splash-retry');
    if (sub) { sub.textContent = 'Connection timed out. Check your internet and retry.'; sub.style.color = '#ef4444'; }
    if (btn) btn.style.display = 'inline-block';
  }
}, 60000);

window.addEventListener('load', function() {
  if (!auth) {
    console.warn('[SpendTrack] Running in offline mode');
    document.getElementById('splash').style.display = 'none';
    document.getElementById('auth-screen').style.display = 'flex';
    return;
  }
  auth.onAuthStateChanged(function(user) {
    // Always resolve the splash on first fire
    if (!_authResolved) {
      _authResolved = true;
      clearTimeout(_splashTimeout);
      document.getElementById('splash').style.display = 'none';
    }

    // Ignore state changes triggered by our own registration/login/OTP flow
    if (_authFlowInProgress) return;

  if (user) {
    // Fast path: Firebase native verified OR same-device localStorage flag
    if (user.emailVerified ||
        (function(){ try { return localStorage.getItem('sptrack_ev_' + user.uid) === '1'; } catch(e){ return false; } })()) {
      _enterApp(user);
      return;
    }
    // Slow path: check Firestore (for cross-device verified sessions)
    db.collection('users').doc(user.uid)
      .collection('settings').doc('main').get()
      .then(function(snap) {
        if (snap.exists && snap.data().sptrackEmailVerified === true) {
          try { localStorage.setItem('sptrack_ev_' + user.uid, '1'); } catch(e) {}
          _enterApp(user);
        } else {
          // User signed in but not OTP-verified ‚Äî sign them back out
          auth.signOut();
        }
      })
      .catch(function() { auth.signOut(); });
  } else {
    // No user signed in.
    // If the OTP panel is currently visible (either register or login flow),
    // don't reset the auth screen ‚Äî the panel must stay up for the user.
    if (document.getElementById('verify-panel').classList.contains('show')) {
      return;
    }
    currentUser = null;
    stopListeners();
    entries    = [];
    categories = JSON.parse(JSON.stringify(DEFAULT_CATS));
    budget     = 50000;
    document.getElementById('app').style.display         = 'none';
    document.getElementById('auth-screen').style.display = 'flex';
    var bl = document.getElementById('btn-login');
    var br = document.getElementById('btn-register');
    if (bl) { bl.disabled = false; bl.textContent = 'Sign In ‚Üí'; }
    if (br) { br.disabled = false; br.textContent = 'Create Account ‚Üí'; }
    }
  });
});

function _enterApp(user) {
  if (currentUser && currentUser.uid === user.uid) return; // already entered
  currentUser = user;
  clearOtpState();
  _authFlowInProgress = false;
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('st-email').textContent = user.email;
  startListeners();
  buildCatPicker();
  buildColorGrid();
  populateSearchCats();
  applyCurrentCurrency();
}

// ‚îÄ‚îÄ‚îÄ FIRESTORE LISTENERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startListeners() {
  setSyncStatus('busy', 'Connecting‚Ä¶');

  unsubSettings = settingsDoc().onSnapshot(function(snap) {
    if (snap.exists) {
      var data = snap.data();
      if (typeof data.budget === 'number') {
        budget = data.budget;
        document.getElementById('bgt-inp').value = budget;
      }
      if (data.currency && CURRENCIES[data.currency]) {
        currency = data.currency;
        localStorage.setItem('currency', currency);
        applyCurrentCurrency();
      }
      if (Array.isArray(data.categories) && data.categories.length) {
        var custom = data.categories.filter(function(c) { return !c.isDefault; });
        var defs   = DEFAULT_CATS.map(function(def) {
          var sv = data.categories.find(function(c) { return c.id === def.id; });
          return sv ? Object.assign({}, def, {name:sv.name, icon:sv.icon, color:sv.color}) : def;
        });
        categories = defs.concat(custom);
        buildCatPicker();
        populateSearchCats();
        if (document.getElementById('page-categories').classList.contains('active')) renderCatManage();
      }
    }
    setSyncStatus('ok', 'Connected ¬∑ real-time sync active');
  }, function(err) {
    setSyncStatus('err', 'Settings sync error');
    console.error('Settings listener error:', err);
  });

  unsubEntries = entriesCol()
    .orderBy('ts', 'desc')
    .onSnapshot(function(snap) {
      entries = snap.docs.map(function(d) {
        return Object.assign({id: d.id}, d.data());
      });
      renderDashboard();
      if (document.getElementById('page-history').classList.contains('active')) renderHistory();
      if (document.getElementById('page-search').classList.contains('active'))  renderSearch();
      setSyncStatus('ok', 'Connected ¬∑ synced ' + new Date().toLocaleTimeString('en-LK',{hour:'2-digit',minute:'2-digit'}));
    }, function(err) {
      setSyncStatus('err', 'Sync error ‚Äî check connection');
      console.error('Entries listener error:', err);
    });
}

function stopListeners() {
  if (unsubEntries)  { unsubEntries();  unsubEntries  = null; }
  if (unsubSettings) { unsubSettings(); unsubSettings = null; }
}

function saveSettings() {
  if (!currentUser) return;
  setSyncStatus('busy', 'Saving‚Ä¶');
  settingsDoc().set({ budget: budget, categories: categories, currency: currency })
    .then(function() {
      setSyncStatus('ok', 'Connected ¬∑ real-time sync active');
    })
    .catch(function(e) {
      setSyncStatus('err', 'Save error: ' + e.message);
    });
}

// ‚îÄ‚îÄ‚îÄ SYNC BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setSyncStatus(state, msg) {
  var bar = document.getElementById('sync-bar');
  var txt = document.getElementById('sync-txt');
  if (!bar) return;
  bar.className = 'sync-bar ' + state;
  txt.textContent = msg;
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function todayStr()  { return new Date().toISOString().split('T')[0]; }
function monthStr()  { var n=new Date(); return n.getFullYear()+'-'+String(n.getMonth()+1).padStart(2,'0'); }
function fmtAmt(n) {
  var cur = CURRENCIES[currency] || CURRENCIES.LKR;
  return cur.symbol + ' ' + Number(n).toLocaleString(cur.locale, {minimumFractionDigits:2, maximumFractionDigits:2});
}
// Keep fmtLKR as alias for backward compat
function fmtLKR(n) { return fmtAmt(n); }
function fmtDate(ds) { return new Date(ds+'T00:00:00').toLocaleDateString('en-LK',{weekday:'short',month:'short',day:'numeric'}); }
function getCat(id)  { return categories.find(function(c){return c.id===id;})||categories.find(function(c){return c.name===id;})||{name:'Other',icon:'üì¶',color:'#6b7280'}; }
function esc(s)      { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function useCount(id){ return entries.filter(function(e){return e.category===id;}).length; }

function currSym() { return (CURRENCIES[currency]||CURRENCIES.LKR).symbol; }

function applyCurrentCurrency() {
  var sym = currSym();
  // Update budget bar symbol
  var bcs = document.getElementById('bgt-curr-sym'); if(bcs) bcs.textContent = sym;
  // Update amount modal prefix
  var ap = document.getElementById('amt-prefix-sym'); if(ap) ap.textContent = sym;
  var al = document.getElementById('amount-lbl'); if(al) al.textContent = 'Amount ('+sym+')';
  // Update currency selector
  var cs = document.getElementById('currency-sel'); if(cs) cs.value = currency;
}

function changeCurrency(val) {
  currency = val;
  localStorage.setItem('currency', val);
  saveSettings();
  applyCurrentCurrency();
  renderDashboard();
  if (document.getElementById('page-history').classList.contains('active')) renderHistory();
  if (document.getElementById('page-search').classList.contains('active'))  renderSearch();
  toast('Currency changed to ' + val + ' ‚úì');
}

// ‚îÄ‚îÄ‚îÄ AMOUNT INPUT AUTO-FORMAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatAmountInput(inp) {
  var raw = inp.value.replace(/,/g, '').replace(/[^0-9.]/g, '');
  // Allow typing decimal point at end
  if (raw === '' || raw === '.') { inp.value = raw; inp._rawAmt = ''; return; }
  var parts = raw.split('.');
  var intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  inp.value = parts.length > 1 ? intPart + '.' + parts[1].slice(0, 2) : intPart;
  inp._rawAmt = raw;
}

function finalizeAmount(inp) {
  var raw = (inp._rawAmt || inp.value.replace(/,/g,'')).replace(/[^0-9.]/g,'');
  if (!raw || isNaN(parseFloat(raw))) { inp.value = ''; inp._rawAmt = ''; return; }
  var n = parseFloat(raw);
  var intPart = Math.floor(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  var dec = (n % 1).toFixed(2).slice(1); // ".00"
  inp.value = intPart + dec;
  inp._rawAmt = String(n);
}

function getRawAmount() {
  var inp = document.getElementById('form-amount');
  var raw = (inp._rawAmt || inp.value.replace(/,/g,'')).replace(/[^0-9.]/g,'');
  return parseFloat(raw);
}

var tT;
function toast(msg, type) {
  type = type || 'success';
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = type; t.classList.add('show');
  clearTimeout(tT); tT = setTimeout(function(){ t.classList.remove('show'); }, 2600);
}

// ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(n) {
  document.querySelectorAll('.page').forEach(function(p){ p.classList.remove('active'); });
  document.querySelectorAll('.nbtn').forEach(function(b){ b.classList.remove('active'); });
  document.getElementById('page-'+n).classList.add('active');
  var nb = document.getElementById('nav-'+n); if (nb) nb.classList.add('active');
  if (n === 'dashboard')  renderDashboard();
  if (n === 'search')     { populateSearchCats(); populateYears(); renderSearch(); }
  if (n === 'history')    renderHistory();
  if (n === 'categories') renderCatManage();
}

// ‚îÄ‚îÄ‚îÄ EDIT MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleEditMode(context) {
  editMode = !editMode;
  ['hist','srch'].forEach(function(ctx) {
    var btn = document.getElementById('edit-mode-btn-'+ctx);
    if (!btn) return;
    btn.classList.toggle('active', editMode);
    btn.textContent = editMode ? '‚úÖ Done' : '‚úèÔ∏è Edit';
  });
  if (document.getElementById('page-history').classList.contains('active')) renderHistory();
  if (document.getElementById('page-search').classList.contains('active'))  renderSearch();
}

// ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeBg(ev, id) { if (ev.target === document.getElementById(id)) closeModal(id); }

function openAddModal() {
  document.getElementById('edit-id').value = '';
  document.getElementById('exp-title').textContent = 'üí∏ Add Expense';
  document.getElementById('form-item').value   = '';
  var amtInp = document.getElementById('form-amount');
  amtInp.value = ''; amtInp._rawAmt = '';
  document.getElementById('form-date').value   = todayStr();
  document.getElementById('form-note').value   = '';
  var cs = document.getElementById('cat-search'); if (cs) cs.value = '';
  selectedCat = (categories[0] && categories[0].id) || 'food';
  buildCatPicker();
  document.getElementById('modal-exp').classList.add('open');
  setTimeout(function(){ document.getElementById('form-item').focus(); }, 300);
}

function openEditModal(id) {
  var e = entries.find(function(x){ return x.id === id; });
  if (!e) return;
  document.getElementById('edit-id').value     = id;
  document.getElementById('exp-title').textContent = '‚úèÔ∏è Edit Entry';
  document.getElementById('form-item').value   = e.item;
  // Format amount for display
  var amtInp = document.getElementById('form-amount');
  amtInp._rawAmt = String(e.amount);
  finalizeAmount(amtInp);
  document.getElementById('form-date').value   = e.date;
  document.getElementById('form-note').value   = e.note || '';
  var cs2 = document.getElementById('cat-search'); if (cs2) cs2.value = '';
  selectedCat = e.category;
  buildCatPicker();
  document.getElementById('modal-exp').classList.add('open');
}

function buildCatPicker() {
  var g = document.getElementById('cat-picker');
  if (!g) return;
  var searchEl = document.getElementById('cat-search');
  var filter = searchEl ? searchEl.value.toLowerCase() : '';
  var visible = categories.filter(function(c){
    return !filter || c.name.toLowerCase().includes(filter) || c.icon.includes(filter);
  });
  g.innerHTML = '';
  visible.forEach(function(c) {
    var el = document.createElement('div');
    el.className = 'cpill' + (c.id === selectedCat ? ' sel' : '');
    el.style.background  = c.id === selectedCat ? c.color + '22' : '';
    el.style.borderColor = c.id === selectedCat ? c.color : 'transparent';
    el.innerHTML = '<div class="cpill-icon">'+c.icon+'</div><div class="cpill-name" style="color:'+(c.id===selectedCat?c.color:'')+'">'+esc(c.name)+'</div>';
    el.onclick = (function(cid){ return function(){ selectedCat = cid; buildCatPicker(); }; })(c.id);
    g.appendChild(el);
  });
  if (!visible.length) g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:16px;color:var(--t3);font-size:13px">No categories found</div>';
}

// ‚îÄ‚îÄ‚îÄ CATEGORY MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCatModal(editId) {
  document.getElementById('cat-edit-id').value = editId || '';
  if (editId) {
    var c = categories.find(function(x){ return x.id === editId; });
    document.getElementById('cat-title').textContent = '‚úèÔ∏è Edit Category';
    document.getElementById('cat-emoji').value = c.icon;
    document.getElementById('cat-name').value  = c.name;
    selColor = c.color;
  } else {
    document.getElementById('cat-title').textContent = '‚ú® New Category';
    document.getElementById('cat-emoji').value = '‚≠ê';
    document.getElementById('cat-name').value  = '';
    selColor = PRESET_COLORS[Math.floor(Math.random() * PRESET_COLORS.length)];
  }
  buildColorGrid(); updatePreview();
  document.getElementById('modal-cat').classList.add('open');
  setTimeout(function(){ document.getElementById('cat-name').focus(); }, 300);
}

function buildColorGrid() {
  var g = document.getElementById('color-grid');
  if (!g) return;
  g.innerHTML = '';
  PRESET_COLORS.forEach(function(col) {
    var el = document.createElement('div');
    el.className = 'cswatch' + (col === selColor ? ' sel' : '');
    el.style.background = col;
    el.onclick = (function(c){ return function(){
      selColor = c;
      document.getElementById('custom-color').value = c;
      buildColorGrid(); updatePreview();
    }; })(col);
    g.appendChild(el);
  });
}

function pickCustomColor(v) {
  selColor = v;
  document.querySelectorAll('.cswatch').forEach(function(s){ s.classList.remove('sel'); });
  updatePreview();
}

function updatePreview() {
  var ico = document.getElementById('cat-emoji').value || '‚≠ê';
  var nm  = document.getElementById('cat-name').value  || 'Category';
  document.getElementById('preview-dot').style.background = selColor;
  var pt = document.getElementById('preview-text');
  pt.textContent = ico + ' ' + nm;
  pt.style.color = selColor;
}

function saveCat() {
  var eid  = document.getElementById('cat-edit-id').value;
  var icon = (document.getElementById('cat-emoji').value || '‚≠ê').trim();
  var name = document.getElementById('cat-name').value.trim();
  if (!name) { toast('Please enter a category name', 'error'); return; }
  if (categories.some(function(c){ return c.name.toLowerCase()===name.toLowerCase() && c.id!==eid; })) {
    toast('Category name already exists', 'error'); return; }
  if (eid) {
    categories = categories.map(function(c){ return c.id===eid ? Object.assign({},c,{name:name,icon:icon,color:selColor}) : c; });
    toast('Category updated! ‚úì');
  } else {
    categories.push({id:'c_'+Date.now(), name:name, icon:icon, color:selColor, isDefault:false});
    toast('Category added! ‚úì');
  }
  saveSettings(); closeModal('modal-cat'); renderCatManage(); renderDashboard();
}

function deleteCat(id) {
  var c = categories.find(function(x){ return x.id === id; });
  if (!c || c.isDefault) { toast('Default categories cannot be deleted', 'error'); return; }
  var n = useCount(id);
  if (!confirm((n > 0 ? '"'+c.name+'" is used in '+n+' entr'+(n===1?'y':'ies')+'. ' : '') + 'Delete "'+c.name+'"?')) return;
  categories = categories.filter(function(x){ return x.id !== id; });
  saveSettings(); renderCatManage(); renderDashboard(); toast('Deleted', 'error');
}

function renderCatManage() {
  document.getElementById('cm-list').innerHTML = categories.map(function(c) {
    var n = useCount(c.id);
    return '<div class="cm-item">'
      + '<div class="cm-ico" style="background:'+c.color+'18">'+c.icon+'</div>'
      + '<div class="cm-info"><div class="cm-name">'+esc(c.name)+'</div><div class="cm-sub">'+n+' entr'+(n===1?'y':'ies')+' &nbsp;¬∑&nbsp; <span style="color:'+c.color+';font-weight:700">'+c.color+'</span></div></div>'
      + '<div class="cm-acts">'
        + '<button class="cm-edit-btn" onclick="openCatModal(\''+c.id+'\')">‚úèÔ∏è Edit</button>'
        + (c.isDefault ? '<span class="cm-badge">Default</span>' : '<button class="cm-del-btn" onclick="deleteCat(\''+c.id+'\')">‚úï</button>')
      + '</div></div>';
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ SAVE / DELETE ENTRIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveEntry() {
  var item   = document.getElementById('form-item').value.trim();
  var amount = getRawAmount();
  var date   = document.getElementById('form-date').value;
  var note   = document.getElementById('form-note').value.trim();
  var eid    = document.getElementById('edit-id').value;
  if (!item)            { toast('Please enter an item name', 'error'); return; }
  if (!amount||amount<=0){ toast('Please enter a valid amount', 'error'); return; }
  if (!date)            { toast('Please select a date', 'error'); return; }

  setSyncStatus('busy', 'Saving‚Ä¶');
  var data = { item:item, amount:amount, date:date, note:note, category:selectedCat, ts:Date.now() };
  var p = eid ? entriesCol().doc(eid).update(data) : entriesCol().add(data);

  p.then(function() {
    toast(eid ? 'Entry updated! ‚úì' : 'Expense saved! ‚úì');
    closeModal('modal-exp');
  }).catch(function(e) {
    toast('Save failed: ' + e.message, 'error');
    setSyncStatus('err', 'Save error');
  });
}

function deleteEntry(id) {
  if (!confirm('Delete this entry?')) return;
  setSyncStatus('busy', 'Deleting‚Ä¶');
  entriesCol().doc(id).delete()
    .then(function() { toast('Deleted', 'error'); })
    .catch(function(e) { toast('Error: ' + e.message, 'error'); });
}

function saveBudget(v) {
  budget = parseFloat(v) || 0;
  saveSettings();
  renderDashboard();
}

// ‚îÄ‚îÄ‚îÄ ENTRY HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function entryHTML(e) {
  var c = getCat(e.category);
  return '<div class="eitem">'
    + '<div class="e-icon" style="background:'+c.color+'18">'+c.icon+'</div>'
    + '<div class="e-info">'
      + '<div class="e-name">'+esc(e.item)+'</div>'
      + '<div class="e-meta">'+fmtDate(e.date)+' ¬∑ '+esc(c.name)+'</div>'
      + (e.note ? '<div class="e-note">"'+esc(e.note)+'"</div>' : '')
    + '</div>'
    + '<div class="e-amt" style="color:'+c.color+'">'+fmtLKR(e.amount)+'</div>'
    + '<div class="e-acts'+(editMode?' visible':'')+'">'
      + '<button class="ibtn ed" onclick="openEditModal(\''+e.id+'\')">‚úèÔ∏è</button>'
      + '<button class="ibtn dl" onclick="deleteEntry(\''+e.id+'\')">‚úï</button>'
    + '</div></div>';
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  var today = todayStr(), ms = monthStr();
  var te = entries.filter(function(e){ return e.date === today; });
  var me = entries.filter(function(e){ return e.date.startsWith(ms); });
  var tt = te.reduce(function(s,e){ return s+e.amount; }, 0);
  var tm = me.reduce(function(s,e){ return s+e.amount; }, 0);

  document.getElementById('stat-today').textContent   = fmtLKR(tt);
  document.getElementById('stat-today-c').textContent = te.length + ' entries';
  document.getElementById('stat-month').textContent   = fmtLKR(tm);
  document.getElementById('stat-month-c').textContent = me.length + ' entries';

  var daysElapsed = new Date().getDate();
  var avg = daysElapsed > 0 ? tm / daysElapsed : 0;
  document.getElementById('stat-avg').textContent = fmtLKR(avg);

  var biggestEl = me.reduce(function(max, e){ return e.amount > (max ? max.amount : -1) ? e : max; }, null);
  if (biggestEl) {
    var bc2 = getCat(biggestEl.category);
    document.getElementById('stat-biggest').textContent     = fmtLKR(biggestEl.amount);
    document.getElementById('stat-biggest-cat').textContent = bc2.icon + ' ' + biggestEl.item.substring(0,12);
  } else {
    document.getElementById('stat-biggest').textContent     = '‚Äî';
    document.getElementById('stat-biggest-cat').textContent = 'no entries';
  }

  var insights = [];
  var now = new Date();
  var weekAgo = new Date(); weekAgo.setDate(now.getDate()-7);
  var twoWeeksAgo = new Date(); twoWeeksAgo.setDate(now.getDate()-14);
  var thisWeek = entries.filter(function(e){ return new Date(e.date+'T00:00:00') >= weekAgo; })
                        .reduce(function(s,e){ return s+e.amount; }, 0);
  var lastWeek = entries.filter(function(e){ var d = new Date(e.date+'T00:00:00'); return d >= twoWeeksAgo && d < weekAgo; })
                        .reduce(function(s,e){ return s+e.amount; }, 0);
  if (lastWeek > 0) {
    var chg = ((thisWeek - lastWeek) / lastWeek * 100).toFixed(0);
    if (Math.abs(chg) >= 5) {
      insights.push({ ico: chg > 0 ? 'üìà' : 'üìâ', txt: 'vs last week', val: (chg > 0 ? '+' : '') + chg + '%', color: chg > 0 ? 'var(--red)' : 'var(--green)' });
    }
  }
  if (me.length) {
    var cm = {}; me.forEach(function(e){ cm[e.category] = (cm[e.category]||0)+e.amount; });
    var topCatId = Object.keys(cm).sort(function(a,b){ return cm[b]-cm[a]; })[0];
    var topCat = getCat(topCatId);
    insights.push({ ico: topCat.icon, txt: 'Top spend', val: topCat.name });
  }
  if (te.length) insights.push({ ico: '‚úÖ', txt: 'Today logged', val: te.length + (te.length===1?' entry':' entries') });
  if (budget > 0) {
    var pctUsed = (tm/budget*100).toFixed(0);
    if (pctUsed >= 90) insights.push({ ico: 'üö®', txt: 'Budget', val: pctUsed + '% used!', color: 'var(--red)' });
    else if (pctUsed >= 70) insights.push({ ico: '‚ö†Ô∏è', txt: 'Budget', val: pctUsed + '% used', color: 'var(--yellow)' });
  }
  var strip = document.getElementById('insights-strip');
  if (insights.length) {
    strip.innerHTML = '<div class="insights-row">' + insights.map(function(ins){
      return '<div class="insight-chip"><span class="i-ico">'+ins.ico+'</span><span class="i-txt">'+ins.txt+'</span><span class="i-val" style="color:'+(ins.color||'var(--primary)')+'">'+ins.val+'</span></div>';
    }).join('') + '</div>';
  } else {
    strip.innerHTML = '';
  }

  var pct = budget > 0 ? Math.min((tm / budget) * 100, 100) : 0;
  var bco  = pct >= 90 ? 'var(--red)' : pct >= 70 ? 'var(--yellow)' : 'var(--green)';
  document.getElementById('bgt-pct').textContent       = pct.toFixed(0) + '%';
  document.getElementById('bgt-pct').style.color       = bco;
  document.getElementById('bgt-fill').style.width      = pct + '%';
  document.getElementById('bgt-fill').style.background = bco;
  document.getElementById('bgt-spent').textContent     = fmtAmt(tm) + ' spent';
  document.getElementById('bgt-left').textContent      = fmtAmt(Math.max(budget - tm, 0)) + ' left';

  // ‚îÄ‚îÄ Sparkline (7-day trend in toolbar chip) ‚îÄ‚îÄ
  var sparkDays = [];
  for (var si = 6; si >= 0; si--) {
    var sd = new Date(); sd.setDate(sd.getDate()-si);
    var sds = sd.toISOString().split('T')[0];
    sparkDays.push(entries.filter(function(e){ return e.date===sds; }).reduce(function(s,e){ return s+e.amount; }, 0));
  }
  var smx = Math.max.apply(null, sparkDays.concat([1]));
  var sb = document.getElementById('spark-bars');
  if (sb) {
    sb.innerHTML = sparkDays.map(function(v){
      return '<div class="tsbar" style="height:'+Math.max((v/smx)*100,8)+'%"></div>';
    }).join('');
  }
  // trend direction label
  var sl = document.getElementById('spark-lbl');
  if (sl) {
    var last3 = sparkDays.slice(4).reduce(function(a,b){return a+b;},0);
    var prev3 = sparkDays.slice(0,3).reduce(function(a,b){return a+b;},0);
    sl.textContent = prev3===0 ? 'last 7 days' : (last3>prev3 ? '‚Üë rising' : last3<prev3 ? '‚Üì falling' : 'stable');
    sl.style.color = prev3===0 ? '' : (last3>prev3 ? 'var(--red)' : last3<prev3 ? 'var(--green)' : '');
  }

  var cmb = {}; me.forEach(function(e){ cmb[e.category] = (cmb[e.category] || 0) + e.amount; });
  var cl = Object.entries(cmb).sort(function(a,b){ return b[1]-a[1]; });
  var bdc = document.getElementById('cat-bd-card');
  var bd  = document.getElementById('cat-bd');
  if (cl.length) {
    bdc.style.display = 'block';
    bd.innerHTML = cl.map(function(pair) {
      var cid = pair[0], amt = pair[1];
      var c = getCat(cid), p = tm > 0 ? (amt/tm*100) : 0;
      return '<div class="cat-row"><div class="cat-row-top"><span class="cat-row-name">'+c.icon+' '+esc(c.name)+'</span><span class="cat-row-amt" style="color:'+c.color+'">'+fmtLKR(amt)+'</span></div><div class="cat-track"><div class="cat-fill" style="width:'+p+'%;background:'+c.color+'"></div></div></div>';
    }).join('');
  } else {
    bdc.style.display = 'none';
  }

  var rl = document.getElementById('recent-list');
  if (!entries.length) {
    rl.innerHTML = '<div class="card empty"><div class="empty-icon">üí∏</div><div class="empty-text">No entries yet. Tap <b>+ Add</b> to start!</div></div>';
  } else {
    rl.innerHTML = entries.slice(0,5).map(entryHTML).join('');
    if (entries.length > 5) rl.innerHTML += '<button class="view-all-btn" onclick="showPage(\'history\')">View all '+entries.length+' entries ‚Üí</button>';
  }
}

// ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateSearchCats() {
  var sel = document.getElementById('s-cat');
  if (!sel) return;
  var cur = sel.value;
  sel.innerHTML = '<option value="">All Categories</option>' +
    categories.map(function(c){ return '<option value="'+c.id+'"'+(c.id===cur?' selected':'')+'>'+c.icon+' '+esc(c.name)+'</option>'; }).join('');
}

function populateYears() {
  var sel = document.getElementById('s-year');
  if (!sel) return;
  var cur = sel.value;
  var years = Array.from(new Set(entries.map(function(e){ return e.date.slice(0,4); }))).sort().reverse();
  var thisY = new Date().getFullYear().toString();
  if (!years.includes(thisY)) years.unshift(thisY);
  sel.innerHTML = '<option value="">All Years</option>' +
    years.map(function(y){ return '<option value="'+y+'"'+(y===cur?' selected':'')+'>'+y+'</option>'; }).join('');
}

function setDateMode(mode) {
  dateMode = mode;
  ['day','month','year'].forEach(function(m) {
    document.getElementById('dmt-'+m).classList.toggle('active', m===mode);
    document.getElementById('dp-'+m).style.display = m===mode ? '' : 'none';
  });
  if (mode === 'year') populateYears();
  renderSearch();
}

function renderSearch() {
  var txt = document.getElementById('s-text').value.toLowerCase();
  var cat = document.getElementById('s-cat').value;

  var dateFilter = '';
  if (dateMode === 'day')   dateFilter = document.getElementById('s-date').value;
  if (dateMode === 'month') dateFilter = document.getElementById('s-month').value;
  if (dateMode === 'year')  dateFilter = document.getElementById('s-year').value;

  var res = entries.filter(function(e) {
    var mT = !txt || e.item.toLowerCase().includes(txt) || (e.note||'').toLowerCase().includes(txt);
    var mC = !cat || e.category === cat;
    var mD = true;
    if (dateFilter) {
      if (dateMode === 'day')   mD = e.date === dateFilter;
      if (dateMode === 'month') mD = e.date.startsWith(dateFilter);
      if (dateMode === 'year')  mD = e.date.startsWith(dateFilter);
    }
    return mT && mC && mD;
  });

  var tot = res.reduce(function(s,e){ return s+e.amount; }, 0);
  document.getElementById('s-count').textContent = res.length + ' result' + (res.length!==1?'s':'') + ' found';
  document.getElementById('s-results').innerHTML = res.length
    ? res.map(entryHTML).join('')
    : '<div class="card empty"><div class="empty-icon">üîç</div><div class="empty-text">No matching entries</div></div>';
  var tc = document.getElementById('s-total-card');
  if (res.length) { tc.style.display='block'; document.getElementById('s-total-amt').textContent=fmtAmt(tot); }
  else tc.style.display = 'none';
}

function clearSearch() {
  document.getElementById('s-text').value  = '';
  document.getElementById('s-cat').value   = '';
  document.getElementById('s-date').value  = '';
  document.getElementById('s-month').value = '';
  document.getElementById('s-year').value  = '';
  renderSearch();
}

// ‚îÄ‚îÄ‚îÄ VIEW ALL (History) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setHistSort(order, btn) {
  histSort = order;
  document.querySelectorAll('.sort-btn').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  renderHistory();
}

function renderHistory() {
  var sorted = entries.slice().sort(function(a, b) {
    return histSort === 'old'
      ? a.date.localeCompare(b.date) || a.ts - b.ts
      : b.date.localeCompare(a.date) || b.ts - a.ts;
  });
  var tot = sorted.reduce(function(s,e){ return s+e.amount; }, 0);
  document.getElementById('hist-total').textContent = sorted.length + ' entries ¬∑ ' + fmtAmt(tot);
  document.getElementById('hist-list').innerHTML = sorted.length
    ? sorted.map(entryHTML).join('')
    : '<div class="card empty"><div class="empty-icon">üìã</div><div class="empty-text">No entries yet.</div></div>';
}

// ‚îÄ‚îÄ‚îÄ EXPORT / IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportJSON() {
  var data = { exportedAt:new Date().toISOString(), version:1, budget:budget, categories:categories, entries:entries };
  var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href = url; a.download = 'spendtrack-backup-' + todayStr() + '.json'; a.click();
  URL.revokeObjectURL(url);
  toast('Exported! ‚úì');
}

function importJSON(event) {
  var file = event.target.files[0]; if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (!data.entries || !Array.isArray(data.entries)) throw new Error('Invalid backup file');
      var confirmed = confirm('Import '+data.entries.length+' entries from backup?\nThis will MERGE ‚Äî no duplicates by ID.');
      if (!confirmed) return;

      setSyncStatus('busy', 'Importing‚Ä¶');
      var existingIds = new Set(entries.map(function(e){ return e.id; }));
      var batch = db.batch();
      var added = 0;

      data.entries.forEach(function(entry) {
        if (!existingIds.has(entry.id)) {
          var ref = entriesCol().doc(entry.id);
          batch.set(ref, {
            item:     entry.item     || '',
            amount:   entry.amount   || 0,
            date:     entry.date     || '',
            note:     entry.note     || '',
            category: entry.category || 'other',
            ts:       entry.ts       || Date.now()
          });
          added++;
        }
      });

      if (data.categories) {
        var newCustom = data.categories.filter(function(c){
          return !c.isDefault && !categories.find(function(x){ return x.id===c.id; });
        });
        categories = categories.concat(newCustom);
      }
      if (typeof data.budget === 'number') { budget = data.budget; }

      batch.commit().then(function() {
        saveSettings();
        toast('Imported ' + added + ' new entries! ‚úì');
      }).catch(function(err) {
        toast('Import failed: ' + err.message, 'error');
        setSyncStatus('err', 'Import error');
      });
    } catch(err) {
      toast('Invalid backup file: ' + err.message, 'error');
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// ‚îÄ‚îÄ‚îÄ CLEAR ALL (danger modal) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDangerModal() {
  document.getElementById('danger-count').textContent = entries.length + ' entr' + (entries.length===1?'y':'ies');
  document.getElementById('danger-inp').value = '';
  document.getElementById('danger-confirm-btn').disabled = true;
  document.getElementById('danger-confirm-btn').classList.remove('ready');
  document.getElementById('modal-danger').classList.add('open');
  setTimeout(function(){ document.getElementById('danger-inp').focus(); }, 200);
}

function closeDangerModal() {
  document.getElementById('modal-danger').classList.remove('open');
}

function checkDangerInput(inp) {
  var ok = inp.value.trim() === 'DELETE';
  var btn = document.getElementById('danger-confirm-btn');
  btn.disabled = !ok;
  btn.classList.toggle('ready', ok);
  inp.classList.toggle('valid', ok);
}

function confirmClearAll() {
  if (document.getElementById('danger-inp').value.trim() !== 'DELETE') return;
  closeDangerModal();
  setSyncStatus('busy', 'Deleting all‚Ä¶');
  var batch = db.batch();
  entries.forEach(function(e) { batch.delete(entriesCol().doc(e.id)); });
  batch.commit()
    .then(function() { toast('All entries cleared', 'error'); })
    .catch(function(err) { toast('Error: ' + err.message, 'error'); });
}

// ‚îÄ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') { closeModal('modal-exp'); closeModal('modal-cat'); closeDangerModal(); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); openAddModal(); }
});

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
buildColorGrid();

// ‚îÄ‚îÄ‚îÄ SERVICE WORKER REGISTRATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(reg) {
      console.log('[SpendTrack] SW registered, scope:', reg.scope);

      // ‚îÄ‚îÄ Detect when a NEW service worker is waiting ‚îÄ‚îÄ
      reg.addEventListener('updatefound', function() {
        var newWorker = reg.installing;
        newWorker.addEventListener('statechange', function() {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // A new version is ready ‚Äî show update toast
            showUpdateBanner();
          }
        });
      });
    }).catch(function(err) {
      console.error('[SpendTrack] SW registration failed:', err);
    });

    // If SW controller changes (new SW took over), reload for fresh version
    var refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', function() {
      if (!refreshing) { refreshing = true; window.location.reload(); }
    });
  });
}

function showUpdateBanner() {
  var t = document.getElementById('update-banner');
  if (t) t.classList.add('show');
}

function applyUpdate() {
  var t = document.getElementById('update-banner');
  if (t) t.classList.remove('show');
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
  }
  window.location.reload();
}
</script>
</body>
</html>
</DOCUMENT>
